<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Meta Tags Essenziali -->
    <title>Mattia Finanze - Gestione Finanziaria Offline Semplice</title>
    <meta name="description" content="Gestisci le tue finanze personali con categorie e sottocategorie, giroconti e backup. Facile, sicuro e offline.">
    <!-- Theme Color per Browser Mobile -->
    <meta name="theme-color" content="#388e3c">

    <!-- Preconnect per CDNs (Performance) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Stili CSS -->
    <style>
        /* style.css - v1.3.0 (Sottocategorie, Giroconti, Backup Reminder) */

        /* --- Import Font --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        /* --- Variabili Globali --- */
        :root {
            /* Color Palette */
            --primary-color: #388e3c; /* Green */
            --primary-color-light: #66bb6a;
            --secondary-color: #0288d1; /* Blue */
            --secondary-color-light: #4fc3f7;
            --accent-color: #ffa000; /* Amber */
            --error-color: #d32f2f; /* Red */
            --success-color: #4CAF50; /* Green */
            --warning-color: #fbc02d; /* Yellow */
            --transfer-color: #757575; /* Grey for transfers */

            /* Text Colors */
            --text-color-light: #212121;
            --text-color-dark: #e0e0e0;
            --text-muted-light: #666;
            --text-muted-dark: #aaa;

            /* Backgrounds */
            --background-light: #f7f9fc;
            --background-dark: #121212;
            --card-background-light: #ffffff;
            --card-background-dark: #1e1e1e;
            --input-bg-light: #ffffff;
            --input-bg-dark: #2c2c2c;
            --banner-bg-light: #fff3e0; /* Light orange for backup banner */
            --banner-bg-dark: #424242;  /* Dark grey for backup banner */

            /* Borders */
            --border-color-light: #e0e0e0;
            --border-color-dark: #3a3a3a;
            --input-border-light: #ccc;
            --input-border-dark: #555;
            --input-height: 40px; /* Define a standard height */

            /* Layout & Sizing */
            --font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --card-padding: 20px;
            --modal-padding: 25px;

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.1);
            --secondary-color-rgb: 2, 136, 209; /* Fallback for rgba() */
            --shadow-focus: 0 0 0 3px rgba(var(--secondary-color-rgb), 0.3);

            /* Transitions */
            --transition-speed: 0.25s;
            --transition-easing: ease-in-out;
        }

        /* --- Keyframe Animations --- */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-focus { 0% { box-shadow: 0 0 0 0 rgba(var(--secondary-color-rgb), 0.4); } 70% { box-shadow: 0 0 0 6px rgba(var(--secondary-color-rgb), 0); } 100% { box-shadow: 0 0 0 0 rgba(var(--secondary-color-rgb), 0); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* --- Reset e Stili Base --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-family); background-color: var(--background-light); color: var(--text-color-light); transition: background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing); line-height: 1.6; font-weight: 400; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; min-height: 100vh; display: flex; flex-direction: column; }
        body.dark-theme { background-color: var(--background-dark); color: var(--text-color-dark); }
        .app-container { flex: 1; display: flex; flex-direction: column; }

        /* --- Accessibilit√† --- */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        :focus-visible { outline: 2px solid var(--secondary-color); outline-offset: 2px; box-shadow: var(--shadow-focus); border-radius: 4px; }
        *:focus:not(:focus-visible) { outline: none; box-shadow: none; }
        .icon-button:focus-visible { outline-offset: 1px; box-shadow: none; }

        /* --- Header --- */
        header { background-color: var(--primary-color); color: #ffffff; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 100; transition: background-color var(--transition-speed) var(--transition-easing); }
        header h1 { font-size: 1.6em; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        header h1 i { font-size: 1.1em; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .theme-switcher { cursor: pointer; font-size: 1.5em; color: #ffffff; transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), color var(--transition-speed) var(--transition-easing); padding: 5px; border-radius: 50%; line-height: 1; background: none; border: none; }
        .theme-switcher:hover { transform: scale(1.1) rotate(15deg); background-color: rgba(255, 255, 255, 0.1); }
        .theme-switcher:active { transform: scale(0.95); }

        /* --- Backup Reminder Banner --- */
        #backup-reminder {
            display: none; /* Hidden by default */
            padding: 10px 15px;
            background-color: var(--banner-bg-light);
            color: var(--text-color-light);
            border-bottom: 1px solid var(--border-color-light);
            text-align: center;
            font-size: 0.9em;
            transition: background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing);
        }
        #backup-reminder i { margin-right: 8px; color: var(--warning-color); }
        #backup-reminder button {
            margin-left: 15px;
            padding: 3px 8px;
            font-size: 0.9em;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
         #backup-reminder button:hover { background-color: var(--secondary-color-light); }
        body.dark-theme #backup-reminder {
            background-color: var(--banner-bg-dark);
            color: var(--text-color-dark);
            border-bottom-color: var(--border-color-dark);
        }
        body.dark-theme #backup-reminder button {
             background-color: var(--secondary-color-light);
             color: var(--background-dark);
        }
        body.dark-theme #backup-reminder button:hover { background-color: var(--secondary-color); color: white; }

        /* --- Main Content --- */
        main { padding: 25px; flex-grow: 1; }
        .card { background-color: var(--card-background-light); color: var(--text-color-light); padding: var(--card-padding); border-radius: var(--border-radius); box-shadow: var(--shadow-md); border: 1px solid transparent; transition: background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing), box-shadow var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing), transform var(--transition-speed) var(--transition-easing); }
        .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        body.dark-theme .card { background-color: var(--card-background-dark); color: var(--text-color-dark); border: 1px solid var(--border-color-dark); box-shadow: none; }
        body.dark-theme .card:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); background-color: color-mix(in srgb, var(--card-background-dark), #fff 3%); border-color: color-mix(in srgb, var(--border-color-dark), #fff 10%); transform: translateY(-3px); }
        section h2, .settings-section h3, .modal-content h2 { margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color); color: var(--primary-color); font-weight: 600; font-size: 1.4em; display: flex; align-items: center; gap: 10px; transition: color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme section h2, body.dark-theme .settings-section h3, body.dark-theme .modal-content h2 { color: var(--primary-color-light); border-bottom-color: var(--primary-color-light); }

        /* --- Login Section --- */
        #login-section { max-width: 380px; margin: 80px auto; text-align: center; padding: 30px 35px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #pin-login { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        #pin-login input[type="password"] { padding: 10px 15px; border: 2px solid var(--input-border-light); border-radius: var(--border-radius); text-align: center; font-size: 1.8em; letter-spacing: 0.5em; width: 160px; background-color: var(--input-bg-light); color: var(--text-color-light); transition: border-color var(--transition-speed) var(--transition-easing), box-shadow var(--transition-speed) var(--transition-easing), background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing); }
        body.dark-theme #pin-login input[type="password"] { background-color: var(--input-bg-dark); color: var(--text-color-dark); border-color: var(--input-border-dark); }
        #pin-login input[type="password"]:focus { border-color: var(--secondary-color); }
        #pin-login input.shake-error { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border-color: var(--error-color) !important; }

        /* --- Layout Griglia App --- */
        .app-grid-layout { display: grid; grid-template-columns: 1fr; gap: 25px; max-width: 1400px; margin: 0 auto; }
        @media screen and (min-width: 992px) { .app-grid-layout { grid-template-columns: minmax(0, 2.5fr) minmax(320px, 1fr); } .grid-item-full-width { grid-column: 1 / -1; } .grid-item-column { display: flex; flex-direction: column; gap: 25px; } }
        .grid-item-full-width { grid-column: 1 / -1; }

        /* --- Sezione Grafici --- */
        #charts-section h2 { margin-bottom: 15px; }
        .chart-totals { text-align: center; margin-bottom: 25px; padding: 12px 15px; background-color: rgba(0,0,0,0.02); border-radius: var(--border-radius); border: 1px solid var(--border-color-light); display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; transition: background-color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .chart-totals { background-color: rgba(255,255,255,0.03); border-color: var(--border-color-dark); }
        .chart-totals p { margin: 0; font-size: 1.1em; font-weight: 500; color: var(--text-color-light); transition: color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .chart-totals p { color: var(--text-color-dark); }
        .chart-totals strong { font-weight: 700; margin-left: 5px; }
        .income-text { color: var(--success-color); } .expense-text { color: var(--error-color); }
        body.dark-theme .income-text { color: var(--primary-color-light); }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 10px; }
        .chart-wrapper { position: relative; min-height: 300px; padding: 15px; background-color: rgba(0,0,0,0.015); border-radius: var(--border-radius); border: 1px solid var(--border-color-light); transition: background-color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .chart-wrapper { background-color: rgba(255,255,255,0.03); border-color: var(--border-color-dark); }
        #income-category-chart, #expense-category-chart { max-height: 380px; width: 100% !important; height: auto !important; }

        /* --- Category Filter Buttons --- */
        .category-filters-container {
            margin-top: 30px; /* Increased space above */
            padding-top: 20px; /* Increased internal space above */
            border-top: 1px solid var(--border-color-light); /* Visual separator */
            display: grid; /* Use grid for layout */
            grid-template-columns: 1fr; /* Default: one column */
            gap: 25px; /* Space between groups */
            transition: border-color var(--transition-speed) var(--transition-easing);
        }
        @media screen and (min-width: 768px) { .category-filters-container { grid-template-columns: 1fr 1fr; } }
        body.dark-theme .category-filters-container { border-top-color: var(--border-color-dark); }
        .category-filters-container h4 { display: none; }
        .filter-group { padding: 15px; background-color: rgba(0,0,0,0.02); border-radius: var(--border-radius); border: 1px solid var(--border-color-light); transition: background-color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .filter-group { background-color: rgba(255,255,255,0.03); border-color: var(--border-color-dark); }
        .filter-group-title { font-size: 1.05em; margin-top: 0; margin-bottom: 15px; font-weight: 600; color: var(--secondary-color); display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color-light); transition: color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        .filter-group-title i { font-size: 0.9em; opacity: 0.9; }
        body.dark-theme .filter-group-title { color: var(--secondary-color-light); border-bottom-color: var(--border-color-dark); }
        .filter-group p { display: none; }
        .category-filter-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-button { padding: 5px 12px; border: 1px solid var(--input-border-light); border-radius: var(--border-radius); background-color: var(--card-background-light); color: var(--text-color-light); font-size: 0.9em; cursor: pointer; transition: background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing), transform 0.1s ease, box-shadow var(--transition-speed) var(--transition-easing); box-shadow: var(--shadow-sm); white-space: nowrap; font-weight: 400; user-select: none; }
         body.dark-theme .filter-button { background-color: var(--card-background-dark); color: var(--text-color-dark); border-color: var(--input-border-dark); }
        .filter-button:hover { border-color: var(--secondary-color); transform: translateY(-1px); box-shadow: var(--shadow-md); filter: brightness(1.03); }
         body.dark-theme .filter-button:hover { border-color: var(--secondary-color-light); background-color: color-mix(in srgb, var(--card-background-dark), #fff 5%); }
        .filter-button.active { background-color: var(--primary-color); color: #ffffff; border-color: var(--primary-color); font-weight: 600; box-shadow: none; }
        body.dark-theme .filter-button.active { background-color: var(--primary-color-light); border-color: var(--primary-color-light); color: var(--background-dark); }
        .filter-button.all-button { font-weight: 600; background-color: color-mix(in srgb, var(--card-background-light), #000 3%); }
        body.dark-theme .filter-button.all-button { background-color: color-mix(in srgb, var(--card-background-dark), #fff 5%); }
        .filter-button.all-button.active { background-color: var(--secondary-color); border-color: var(--secondary-color); color: #ffffff; }
        body.dark-theme .filter-button.all-button.active { background-color: var(--secondary-color-light); border-color: var(--secondary-color-light); color: var(--background-dark); }

        /* --- Sezioni Liste (Conti, Transazioni, Obiettivi, Categorie) --- */
        .data-list { list-style: none; padding: 0; margin-top: 15px; max-height: 450px; overflow-y: auto; padding-right: 8px; scrollbar-width: thin; scrollbar-color: var(--secondary-color) transparent; }
        .data-list::-webkit-scrollbar { width: 6px; } .data-list::-webkit-scrollbar-track { background: transparent; } .data-list::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 10px; }
        body.dark-theme .data-list { scrollbar-color: var(--secondary-color-light) transparent; } body.dark-theme .data-list::-webkit-scrollbar-thumb { background-color: var(--secondary-color-light); }
        .list-item-placeholder { display: none; padding: 25px; text-align: center; color: var(--text-muted-light); font-style: italic; border: 2px dashed var(--border-color-light); border-radius: var(--border-radius); opacity: 0.8; margin: 10px 0; transition: border-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .list-item-placeholder { color: var(--text-muted-dark); border-color: var(--border-color-dark); }
        .list-item { background-color: var(--card-background-light); padding: 15px; margin-bottom: 12px; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color-light); box-shadow: var(--shadow-sm); position: relative; overflow: hidden; opacity: 0; animation: fadeInUp 0.4s var(--transition-easing) forwards; transition: background-color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing), transform var(--transition-speed) var(--transition-easing), box-shadow var(--transition-speed) var(--transition-easing); }
        .list-item:nth-child(odd) { animation-delay: 0.05s; } .list-item:nth-child(even) { animation-delay: 0.1s; }
        .list-item:hover { transform: translateY(-2px) scale(1.005); box-shadow: var(--shadow-md); border-color: var(--secondary-color); z-index: 10; }
        body.dark-theme .list-item { background-color: var(--card-background-dark); border-color: var(--border-color-dark); box-shadow: none; }
        body.dark-theme .list-item:hover { background-color: color-mix(in srgb, var(--card-background-dark), #fff 4%); border-color: var(--secondary-color-light); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); }
        .item-info { flex-grow: 1; margin-right: 15px; overflow: hidden; }
        .item-name { font-weight: 600; margin-bottom: 4px; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color-light); transition: color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .item-name { color: var(--text-color-dark); }
        /* Category Hierarchy Styling */
        .list-item.category-item--main { font-weight: bold; background-color: rgba(0,0,0,0.02); }
        .list-item.category-item--sub { padding-left: 30px; }
        .list-item.category-item--sub::before { content: "‚Ü≥"; position: absolute; left: 15px; color: var(--text-muted-light); }
        body.dark-theme .list-item.category-item--main { background-color: rgba(255,255,255,0.04); }
        body.dark-theme .list-item.category-item--sub::before { color: var(--text-muted-dark); }

        .account-balance, .goal-target { font-size: 1.05em; color: var(--secondary-color); font-weight: 600; }
        body.dark-theme .account-balance, body.dark-theme .goal-target { color: var(--secondary-color-light); }
        .account-item small.text-muted { font-size: 0.85em; opacity: 0.8; }
        .transaction-details p { margin-bottom: 3px; font-size: 1em; line-height: 1.4; }
        .transaction-description { font-style: italic; color: var(--text-muted-light); word-break: break-word; font-size: 0.95em; }
        body.dark-theme .transaction-description { color: var(--text-muted-dark); }
        .transaction-amount { font-weight: 700; font-size: 1.15em; margin-bottom: 5px !important; }
        .transaction-amount.expense { color: var(--error-color); } .transaction-amount.income { color: var(--success-color); }
        .transaction-amount.transfer { color: var(--transfer-color); font-style: italic;} /* Style for transfers */
        body.dark-theme .transaction-amount.income { color: var(--primary-color-light); }
        .transaction-meta { font-size: 0.9em; color: var(--text-muted-light); display: flex; flex-wrap: wrap; gap: 6px 12px; margin-top: 6px; }
        .transaction-meta span { display: inline-flex; align-items: center; gap: 5px; } .transaction-meta i { font-size: 0.95em; opacity: 0.8; }
        .transaction-meta .category-path { font-style: italic; } /* Style for category path */
        body.dark-theme .transaction-meta { color: var(--text-muted-dark); }
        .item-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
        .icon-button { background: none; border: none; cursor: pointer; font-size: 1.15em; color: var(--text-muted-light); padding: 8px; border-radius: 50%; transition: background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing), transform 0.2s ease; line-height: 1; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; }
        .icon-button:hover:not(:disabled) { background-color: rgba(var(--secondary-color-rgb), 0.1); transform: scale(1.1); }
        .icon-button.edit-button:hover:not(:disabled) { color: var(--secondary-color); }
        .icon-button.delete-button:hover:not(:disabled) { color: var(--error-color); background-color: rgba(211, 47, 47, 0.1); }
        .icon-button.add-subcategory-button:hover:not(:disabled) { color: var(--primary-color); background-color: rgba(76, 175, 80, 0.1); } /* Style for add subcategory */
        .icon-button:active:not(:disabled) { transform: scale(0.9); }
        .icon-button:disabled, .icon-button[disabled] { opacity: 0.4; cursor: not-allowed; }
        body.dark-theme .icon-button { color: var(--text-muted-dark); }
        body.dark-theme .icon-button:hover:not(:disabled) { background-color: rgba(var(--secondary-color-rgb), 0.15); }
        body.dark-theme .icon-button.edit-button:hover:not(:disabled) { color: var(--secondary-color-light); }
        body.dark-theme .icon-button.delete-button:hover:not(:disabled) { color: #ff8a80; background-color: rgba(255, 138, 128, 0.15); }
        body.dark-theme .icon-button.add-subcategory-button:hover:not(:disabled) { color: var(--primary-color-light); background-color: rgba(102, 187, 106, 0.15); }
        body.dark-theme .icon-button:disabled, body.dark-theme .icon-button[disabled] { color: var(--text-muted-dark); opacity: 0.4; }
        .account-item { border-left: 5px solid var(--account-color, var(--primary-color)); padding-left: 15px; }
        .account-item:hover { border-color: var(--secondary-color); border-left-color: var(--account-color, var(--primary-color)); }

        /* --- Controlli Transazioni (Filtri & Ricerca) --- */
        .transactions-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center; padding: 12px 15px; background-color: rgba(0,0,0,0.02); border-radius: var(--border-radius); border: 1px solid var(--border-color-light); transition: background-color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .transactions-controls { background-color: rgba(255,255,255,0.03); border-color: var(--border-color-dark); }
        /* NEW: Add space for transfer button */
        .transactions-controls > button { margin-right: 5px;}
        .search-wrapper { position: relative; flex-grow: 1; min-width: 180px; }
        #search-transaction-input { padding: 9px 15px 9px 38px; width: 100%; height: var(--input-height); border-radius: var(--border-radius); border: 1px solid var(--input-border-light); background-color: var(--input-bg-light); color: var(--text-color-light); font-size: 0.95em; font-family: var(--font-family); transition: border-color var(--transition-speed) var(--transition-easing), box-shadow var(--transition-speed) var(--transition-easing), background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing); }
        body.dark-theme #search-transaction-input { background-color: var(--input-bg-dark); color: var(--text-color-dark); border-color: var(--input-border-dark); }
        #search-transaction-input:focus { border-color: var(--secondary-color); outline: none; box-shadow: var(--shadow-focus); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted-light); font-size: 0.9em; pointer-events: none; transition: color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .search-icon { color: var(--text-muted-dark); }
        #search-transaction-input:focus + .search-icon { color: var(--secondary-color); }
        #search-transaction-input::-webkit-search-cancel-button { cursor: pointer; opacity: 0.7; } body.dark-theme #search-transaction-input::-webkit-search-cancel-button { filter: invert(80%) brightness(1.1); }
        .filters { display: flex; gap: 10px; }
        .filters select { padding: 9px 15px; height: var(--input-height); border-radius: var(--border-radius); border: 1px solid var(--input-border-light); background-color: var(--input-bg-light); color: var(--text-color-light); font-size: 0.95em; font-family: var(--font-family); appearance: none; cursor: pointer; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23555"><path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"/></svg>'); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 35px; transition: border-color var(--transition-speed) var(--transition-easing), box-shadow var(--transition-speed) var(--transition-easing), background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing); min-width: 150px; }
        body.dark-theme .filters select { background-color: var(--input-bg-dark); color: var(--text-color-dark); border-color: var(--input-border-dark); background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23bbb"><path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"/></svg>'); }
        .filters select:focus { border-color: var(--secondary-color); outline: none; box-shadow: var(--shadow-focus); }
        .filters select option[value=""] { color: var(--text-muted-light); font-style: italic; } body.dark-theme .filters select option[value=""] { color: var(--text-muted-dark); }
        /* Style for optgroup in selects */
        select optgroup { font-weight: bold; font-style: normal; color: var(--primary-color); }
        select option { padding-left: 10px; }
        body.dark-theme select optgroup { color: var(--primary-color-light); background-color: var(--input-bg-dark); } /* Background might be needed for some browsers */
        body.dark-theme select option { background-color: var(--input-bg-dark); }

        /* --- Bottoni Generali --- */
        .button { padding: 10px 20px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 500; text-align: center; transition: background-color var(--transition-speed) var(--transition-easing), transform 0.15s ease, box-shadow var(--transition-speed) var(--transition-easing), filter var(--transition-speed) var(--transition-easing); display: inline-flex; align-items: center; justify-content: center; gap: 8px; line-height: 1.4; box-shadow: var(--shadow-sm); white-space: nowrap; transform: translateY(0); min-height: var(--input-height); }
        .button i { font-size: 1em; line-height: 1; vertical-align: middle; margin-bottom: -1px; }
        .button:hover:not(:disabled) { box-shadow: var(--shadow-md); transform: translateY(-2px); filter: brightness(1.05); }
        .button:active:not(:disabled) { transform: translateY(0px) scale(0.98); box-shadow: none; filter: brightness(0.95); }
        .button:disabled, .button[disabled] { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; background-color: #ccc !important; color: #777 !important; filter: grayscale(50%); pointer-events: none; }
        .button.primary-button { background-color: var(--primary-color); color: #ffffff; } .button.primary-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--primary-color), #000 5%); }
        .button.secondary-button { background-color: var(--secondary-color); color: #ffffff; } .button.secondary-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--secondary-color), #000 5%); }
        .button.danger-button { background-color: var(--error-color); color: #ffffff; } .button.danger-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--error-color), #000 5%); }
        .button.small-button { padding: 7px 14px; font-size: 0.9em; gap: 6px; min-height: calc(var(--input-height) * 0.9); }
        /* Button for transfers */
        .button.transfer-button { background-color: var(--transfer-color); color: #ffffff; }
        .button.transfer-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--transfer-color), #000 10%); }

        /* --- Footer --- */
        footer { text-align: center; padding: 15px; background-color: var(--card-background-light); color: var(--text-muted-light); font-size: 0.9em; margin-top: 30px; box-shadow: 0 -4px 10px rgba(0,0,0,0.03); border-top: 1px solid var(--border-color-light); transition: background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme footer { background-color: var(--card-background-dark); color: var(--text-muted-dark); border-top: 1px solid var(--border-color-dark); box-shadow: 0 -4px 15px rgba(0,0,0,0.1); }

        /* --- Modals --- */
        .modal { display: flex; align-items: center; justify-content: center; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow-y: auto; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); padding: 20px; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility 0s linear var(--transition-speed); }
        .modal.active { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background-color: var(--card-background-light); color: var(--text-color-light); margin: auto; padding: var(--modal-padding); border-radius: var(--border-radius); width: 90%; max-width: 550px; box-shadow: var(--shadow-lg); position: relative; max-height: calc(100vh - 60px); overflow-y: auto; transform: scale(0.95) translateY(10px); opacity: 0; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease, background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing); transform-origin: center center; }
        .modal.active .modal-content { transform: scale(1) translateY(0); opacity: 1; }
        body.dark-theme .modal-content { background-color: var(--card-background-dark); color: var(--text-color-dark); border: 1px solid var(--border-color-dark); }
        .close-button { position: absolute; top: 10px; right: 12px; color: var(--text-muted-light); background: none; border: none; font-size: 1.8em; font-weight: bold; cursor: pointer; line-height: 1; padding: 5px; transition: color var(--transition-speed) var(--transition-easing), transform 0.2s ease, background-color var(--transition-speed) var(--transition-easing); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .close-button:hover { color: var(--error-color); transform: rotate(90deg); background-color: rgba(211, 47, 47, 0.08); }
        body.dark-theme .close-button { color: var(--text-muted-dark); } body.dark-theme .close-button:hover { color: #ff8a80; background-color: rgba(255, 138, 128, 0.1); }
        #category-modal { z-index: 1010; }
        #transfer-modal { z-index: 1005; } /* Ensure transfer modal is above others if needed */

        /* --- Form all'interno dei Modals --- */
        form { margin-top: 20px; }
        form div { margin-bottom: 18px; }
        form label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95em; color: var(--text-muted-light); transition: color var(--transition-speed) var(--transition-easing); }
        body.dark-theme form label { color: var(--text-muted-dark); }
        form input[type="text"], form input[type="number"], form input[type="date"], form input[type="password"], form select, form textarea { width: 100%; height: var(--input-height); padding: 10px 12px; border: 1px solid var(--input-border-light); border-radius: var(--border-radius); background-color: var(--input-bg-light); color: var(--text-color-light); font-family: var(--font-family); font-size: 1em; transition: border-color var(--transition-speed) var(--transition-easing), box-shadow var(--transition-speed) var(--transition-easing), background-color var(--transition-speed) var(--transition-easing), color var(--transition-speed) var(--transition-easing); }
        form input[type="password"]#pin-input { height: auto; } /* Exception login PIN */
        form input[type="password"]#change-pin-input { height: var(--input-height); /* Match settings PIN */ }
        form input[type="color"] { width: 50px; height: 36px; padding: 4px; border-radius: var(--border-radius); border: 1px solid var(--input-border-light); cursor: pointer; vertical-align: middle; }
        body.dark-theme form input:not([type="color"]):not(#pin-input), body.dark-theme form select, body.dark-theme form textarea { background-color: var(--input-bg-dark); color: var(--text-color-dark); border-color: var(--input-border-dark); }
        body.dark-theme form input[type="color"] { border-color: var(--input-border-dark); }
        form input:focus, form select:focus, form textarea:focus { border-color: var(--secondary-color); outline: none; box-shadow: var(--shadow-focus); }
        form input[aria-invalid="true"], form select[aria-invalid="true"], form textarea[aria-invalid="true"] { border-color: var(--error-color); box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.2) !important; }
        form select { appearance: none; cursor: pointer; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23555"><path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px; }
        body.dark-theme form select { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23bbb"><path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"/></svg>'); }
        form select option[value=""][disabled] { color: var(--text-muted-light); font-style: italic; } body.dark-theme form select option[value=""][disabled] { color: var(--text-muted-dark); }
        .error-message, .success-message { font-size: 0.9em; margin-top: 6px; min-height: 1.2em; font-weight: 500; display: block; transition: color var(--transition-speed) var(--transition-easing); }
        .error-message { color: var(--error-color); } .success-message { color: var(--success-color); }
        .field-error { /* Style for errors under a specific field */ }
        .form-error { font-weight: bold; margin-top: 15px; text-align: center; }
        #no-categories-warning { color: var(--warning-color); }

        /* --- Impostazioni Modal --- */
        .settings-section { margin-bottom: 30px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color-light); transition: border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .settings-section { border-bottom-color: var(--border-color-dark); }
        .settings-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .setting-item { margin-top: 15px; padding: 15px; background-color: rgba(0,0,0,0.015); border-radius: var(--border-radius); border: 1px solid var(--border-color-light); transition: background-color var(--transition-speed) var(--transition-easing), border-color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .setting-item { background-color: rgba(255,255,255,0.025); border-color: var(--border-color-dark); }
        .setting-item > label:first-child { font-weight: 600; display: block; margin-bottom: 10px; font-size: 1em; color: var(--text-color-light); transition: color var(--transition-speed) var(--transition-easing); }
        body.dark-theme .setting-item > label:first-child { color: var(--text-color-dark); }
        .setting-item h4 { margin-top: 18px; margin-bottom: 12px; font-size: 1.1em; font-weight: 600; color: var(--secondary-color); }
        body.dark-theme .setting-item h4 { color: var(--secondary-color-light); }
        /* Category settings specific */
        .category-actions { display: flex; gap: 10px; margin-bottom: 15px;}

        /* Stile Cambio PIN */
        .pin-change-controls { display: flex; gap: 12px; align-items: center; margin-top: 5px; position: relative; }
        .pin-change-controls input[type="password"] { flex-grow: 1; font-size: 1.1em; letter-spacing: 0.3em; }
        .pin-change-button { /* Using standard button styles + small-button */ flex-shrink: 0; /* Prevent shrinking */ }
        .pin-change-button .button-text { margin-left: 6px; }
        /* Focus styling handled by general :focus-visible */
        .setting-item .success-message, .setting-item .error-message { margin-top: 8px; font-size: 0.9em; }

        /* Data actions */
        .data-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .data-actions .button { width: 100%; font-weight: 500; }
        .hidden-input { display: none; }
        .settings-list { max-height: 250px; overflow-y: auto; padding-right: 8px; margin-top: 10px;}
        .settings-list .list-item { padding: 10px 12px; margin-bottom: 8px; opacity: 1; animation: none; }
        .text-muted.small { font-size: 0.85em; color: var(--text-muted-light); margin-top: 5px; display: block; }
        body.dark-theme .text-muted.small { color: var(--text-muted-dark); }

        /* --- Responsive Design Adjustments --- */
        @media screen and (max-width: 768px) {
            html { font-size: 15px; } header { padding: 10px 15px; } header h1 { font-size: 1.4em; gap: 8px; } .header-actions { gap: 15px; } main { padding: 15px; } .app-grid-layout { gap: 20px; }
            section h2, .settings-section h3, .modal-content h2 { font-size: 1.3em; } .card { padding: 15px; } .card:hover { transform: none; }
            .chart-totals p { font-size: 1em; }
            .transactions-controls { padding: 10px; flex-direction: column; align-items: stretch; gap: 10px; }
            .transactions-controls > button { order: 1; width: auto; align-self: flex-start;} /* Adjust button positioning */
            .search-wrapper { order: 2; min-width: 100%; margin-right: 0; }
            .filters { order: 3; flex-direction: column; width: 100%; gap: 8px; } .filters select { width: 100%; min-width: unset; }
            .data-list { max-height: 350px; } .modal-content { padding: 20px 15px; max-width: 95%; } .data-actions { grid-template-columns: 1fr; gap: 10px; }
            .button { padding: 10px 16px; font-size: 0.95em; } .icon-button { width: 34px; height: 34px; padding: 7px; font-size: 1.15em; } .item-info { margin-right: 10px; }
            /* Responsive Category Filters */
            .category-filters-container { padding-top: 15px; gap: 15px; } /* Reduce gap on mobile */
            .filter-group { padding: 12px; }
            .filter-group-title { font-size: 1em; margin-bottom: 12px; padding-bottom: 6px;}
            .filter-button { padding: 4px 10px; font-size: 0.85em; }
            .list-item.category-item--sub { padding-left: 25px; } /* Adjust subcategory indent */
             .list-item.category-item--sub::before { left: 10px; }
        }
        @media screen and (max-width: 480px) {
            html { font-size: 14px; } header { padding: 8px 12px; } header h1 { font-size: 1.25em; } .header-actions { gap: 10px; } .theme-switcher { font-size: 1.3em; } main { padding: 10px; } .app-grid-layout { gap: 15px; }
            section h2, .settings-section h3, .modal-content h2 { font-size: 1.2em; } .card { padding: 12px; border-radius: 6px; }
            .chart-totals { padding: 10px; gap: 10px; } .chart-totals p { font-size: 0.95em; }
            .list-item { padding: 10px 12px; margin-bottom: 10px; border-radius: 6px; } .item-name { font-size: 1em; } .account-balance, .goal-target, .transaction-amount { font-size: 1em; }
            .transaction-meta { font-size: 0.8em; gap: 4px 8px; } .button { font-size: 0.9em; padding: 8px 14px; gap: 6px; }
            .button.small-button { padding: 6px 10px; font-size: 0.85em;} .icon-button { width: 32px; height: 32px; padding: 6px; font-size: 1em; } .item-actions { gap: 6px; }
            .modal-content { padding: 15px 12px; border-radius: 6px;} .close-button { font-size: 1.8em; top: 6px; right: 8px; width: 32px; height: 32px;}
            form input:not([type='color']):not(#pin-input), form select, form textarea { padding: 9px 10px; height: calc(var(--input-height) * 0.95); } form div { margin-bottom: 15px; }
            #pin-login input[type="password"] { font-size: 1.6em; width: 140px; letter-spacing: 0.4em; }
            .transactions-controls { gap: 8px; } .filters { gap: 6px; }
            .filters select { padding: 8px 10px; padding-right: 30px; background-size: 14px; min-width: 100px; }
            .setting-item { padding: 12px; } .data-actions { grid-template-columns: 1fr; gap: 8px; }
            .pin-change-button .button-text { display: none; } /* Hide text on small screens */
            /* Responsive Category Filters */
            .category-filters-container { margin-top: 20px; gap: 15px; } /* Reduce gap */
            .filter-group { padding: 10px; }
            .filter-group-title { font-size: 0.95em; margin-bottom: 10px; gap: 6px; }
            .filter-button { padding: 3px 8px; font-size: 0.8em; gap: 6px; }
             .list-item.category-item--sub { padding-left: 20px; } /* Adjust subcategory indent */
             .list-item.category-item--sub::before { left: 8px; }
        }
    </style>

    <!-- Font Awesome (Icone) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Chart.js (Grafici) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

    <!-- Favicon -->
    <link rel="icon" href="./favicon.ico" sizes="any">

</head>
<body>
    <!-- Banner Promemoria Backup -->
    <div id="backup-reminder" style="display: none;">
        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> √à passato pi√π di un mese dall'ultimo backup. Si consiglia di esportare i dati!
        <button id="backup-reminder-export-btn" class="button small-button secondary-button">Esporta Ora</button>
        <button id="backup-reminder-dismiss-btn" aria-label="Ignora promemoria backup">√ó</button>
    </div>

    <div class="app-container">
        <header>
            <h1><i class="fas fa-piggy-bank" aria-hidden="true"></i> Mattia Finanze</h1>
            <div class="header-actions">
                <div class="theme-switcher" title="Cambia Tema (Chiaro/Scuro)">
                    <i class="fas fa-sun" id="theme-icon" aria-hidden="true"></i>
                     <span class="sr-only">Attiva/Disattiva Tema Scuro</span>
                </div>
                <button id="settings-button" class="button secondary-button" aria-label="Apri Impostazioni Applicazione">
                    <i class="fas fa-cog" aria-hidden="true"></i> Impostazioni
                </button>
            </div>
        </header>
<!-- FINE PARTE 1 -->

<!-- INIZIO PARTE 2 -->
        <main>
            <!-- Sezione Login -->
            <section id="login-section" class="card">
                <h2><i class="fas fa-lock" aria-hidden="true"></i> Accesso Sicuro</h2>
                <div id="pin-login">
                    <label for="pin-input" class="sr-only">Inserisci il tuo PIN a 4 cifre</label>
                    <input type="password" id="pin-input" maxlength="4" placeholder="****" inputmode="numeric" autocomplete="off" aria-describedby="login-error" required />
                    <button id="login-button" class="button primary-button">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i> Accedi
                    </button>
                    <p id="login-error" class="error-message form-error" aria-live="polite"></p>
                </div>
            </section> <!-- Fine #login-section -->

            <!-- Contenuto App -->
            <div id="app-content" style="display:none;">
                <div class="app-grid-layout">

                   <!-- Sezione Grafici con Totali -->
                    <section id="charts-section" class="grid-item grid-item-full-width card">
                        <h2><i class="fas fa-chart-pie" aria-hidden="true"></i> Riepilogo (Categorie Principali Filtrate)</h2>
                        <div class="chart-totals">
                             <p>Entrate Selezionate: <strong id="total-income-display" class="income-text">‚Ç¨0,00</strong></p>
                             <p>Spese Selezionate: <strong id="total-expense-display" class="expense-text">‚Ç¨0,00</strong></p>
                        </div>
                        <div class="charts-container">
                            <div class="chart-wrapper">
                                <canvas id="income-category-chart" role="img" aria-label="Grafico a ciambella: Distribuzione entrate per categoria principale"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="expense-category-chart" role="img" aria-label="Grafico a ciambella: Distribuzione spese per categoria principale"></canvas>
                            </div>
                        </div>
                        <!-- Sezione Filtri Categoria (Layout Migliorato) -->
                        <div id="category-filters-container" class="category-filters-container" style="display: none;">
                            <div class="filter-group">
                                <h5 class="filter-group-title"><i class="fas fa-arrow-down income-text" aria-hidden="true"></i> Filtro Categorie Principali (Entrate)</h5>
                                <div id="income-category-filters" class="category-filter-buttons">
                                    <!-- Pulsanti generati da JS -->
                                </div>
                            </div>
                            <div class="filter-group">
                                <h5 class="filter-group-title"><i class="fas fa-arrow-up expense-text" aria-hidden="true"></i> Filtro Categorie Principali (Spese)</h5>
                                <div id="expense-category-filters" class="category-filter-buttons">
                                     <!-- Pulsanti generati da JS -->
                                </div>
                            </div>
                        </div> <!-- Fine #category-filters-container -->
                    </section> <!-- Fine #charts-section -->

                    <!-- Colonna Sinistra/Superiore -->
                    <div class="grid-item-column">
                         <section id="accounts-section" class="card">
                            <h2><i class="fas fa-wallet" aria-hidden="true"></i> I Miei Conti</h2>
                            <button id="add-account-btn" class="button primary-button small-button"> <i class="fas fa-plus" aria-hidden="true"></i> Aggiungi Conto </button>
                            <ul id="accounts-list" class="data-list" aria-live="polite" aria-relevant="additions removals">
                                <li class="list-item-placeholder" style="display: none;">Nessun conto aggiunto.</li>
                            </ul>
                        </section> <!-- Fine #accounts-section -->

                        <section id="transactions-section" class="card">
                            <h2><i class="fas fa-exchange-alt" aria-hidden="true"></i> Transazioni</h2>
                             <div class="transactions-controls">
                                <button id="add-transaction-btn" class="button primary-button small-button"> <i class="fas fa-plus" aria-hidden="true"></i> Nuova </button>
                                <!-- NEW: Transfer Button -->
                                <button id="add-transfer-btn" class="button transfer-button small-button"> <i class="fas fa-random" aria-hidden="true"></i> Giroconto </button>
                                <div class="search-wrapper">
                                    <label for="search-transaction-input" class="sr-only">Cerca Transazioni</label>
                                    <input type="search" id="search-transaction-input" placeholder="Cerca..." title="Cerca per descrizione, categoria o importo">
                                    <i class="fas fa-search search-icon" aria-hidden="true"></i>
                                </div>
                                <div class="filters">
                                    <label for="filter-account" class="sr-only">Filtra per Conto</label>
                                    <select id="filter-account" title="Filtra per Conto">
                                        <option value="">Tutti i Conti</option>
                                    </select>
                                    <label for="filter-category" class="sr-only">Filtra per Categoria</label>
                                    <select id="filter-category" title="Filtra per Categoria/Sottocategoria">
                                        <option value="">Tutte le Categorie</option>
                                        <!-- Options generated by JS with optgroups -->
                                    </select>
                                </div>
                            </div>
                            <ul id="transactions-list" class="data-list" aria-live="polite" aria-relevant="additions removals">
                                <li class="list-item-placeholder" style="display: none;">Nessuna transazione trovata.</li>
                            </ul>
                        </section> <!-- Fine #transactions-section -->
                    </div> <!-- Fine .grid-item-column -->

                     <!-- Colonna Destra/Inferiore -->
                    <section id="savings-goals-section" class="grid-item card">
                        <h2><i class="fas fa-bullseye" aria-hidden="true"></i> Obiettivi di Risparmio</h2>
                        <button id="add-goal-btn" class="button primary-button small-button"> <i class="fas fa-plus" aria-hidden="true"></i> Aggiungi Obiettivo </button>
                        <ul id="savings-goals-list" class="data-list" aria-live="polite" aria-relevant="additions removals">
                             <li class="list-item-placeholder" style="display: none;">Nessun obiettivo impostato.</li>
                        </ul>
                    </section> <!-- Fine #savings-goals-section -->

                </div> <!-- Fine .app-grid-layout -->
            </div> <!-- Fine #app-content -->
        </main>
<!-- FINE PARTE 2 -->

<!-- INIZIO PARTE 3 -->
        <footer>
            <p>¬© <span id="current-year"></span> Mattia Finanze - Gestione Finanziaria Semplice e Offline.</p>
        </footer>
    </div> <!-- Fine .app-container -->

    <!-- ========= MODALS ========= -->

    <!-- Modal Conto -->
    <div id="account-modal" class="modal" aria-labelledby="account-modal-title" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="close-button" aria-label="Chiudi finestra modale Conto">√ó</button>
            <h2 id="account-modal-title">Aggiungi Conto</h2> <!-- Title changes via JS -->
            <form id="account-form" novalidate>
                <input type="hidden" id="account-id"> <!-- ID will be set here for edits -->
                <div>
                    <label for="account-name">Nome Conto:</label>
                    <input type="text" id="account-name" required aria-describedby="account-name-error">
                    <p id="account-name-error" class="error-message field-error" aria-live="polite"></p>
                </div>
                <div>
                    <label for="account-initial-balance">Saldo Iniziale (‚Ç¨):</label>
                    <input type="number" id="account-initial-balance" step="0.01" value="0.00" required aria-describedby="account-initial-balance-error" placeholder="0.00">
                    <p id="account-initial-balance-error" class="error-message field-error" aria-live="polite"></p>
                </div>
                 <div>
                    <label for="account-color">Colore Etichetta:</label>
                    <input type="color" id="account-color" value="#4CAF50" title="Scegli un colore">
                 </div>
                <button type="submit" class="button primary-button"><i class="fas fa-save" aria-hidden="true"></i> Salva Conto</button>
                <p id="account-modal-error" class="error-message form-error" aria-live="polite"></p>
            </form>
        </div>
    </div> <!-- Fine #account-modal -->

    <!-- Modal Transazione -->
    <div id="transaction-modal" class="modal" aria-labelledby="transaction-modal-title" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="close-button" aria-label="Chiudi finestra modale Transazione">√ó</button>
            <h2 id="transaction-modal-title">Aggiungi Transazione</h2> <!-- Title changes via JS -->
            <form id="transaction-form" novalidate>
                <input type="hidden" id="transaction-id"> <!-- ID will be set here for edits -->
                 <!-- NEW: hidden field for transfer ID -->
                 <input type="hidden" id="transfer-id">
                <div> <label for="transaction-date">Data:</label> <input type="date" id="transaction-date" required aria-describedby="transaction-date-error"> <p id="transaction-date-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div> <label for="transaction-amount">Importo (‚Ç¨):</label> <input type="number" id="transaction-amount" step="0.01" required placeholder="Es: -50.00 (spesa) o 1200.50 (entrata)" aria-describedby="transaction-amount-error"> <p id="transaction-amount-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div>
                    <label for="transaction-category">Categoria/Sottocategoria:</label>
                    <select id="transaction-category" required aria-describedby="transaction-category-error">
                        <option value="" disabled selected>-- Seleziona Categoria --</option>
                        <!-- Options/Optgroups generated by JS -->
                    </select>
                    <p id="transaction-category-error" class="error-message field-error" aria-live="polite"></p>
                    <small class="text-muted" id="no-categories-warning" style="display: none; margin-top: 5px;">Nessuna categoria disponibile. Aggiungine una dalle Impostazioni.</small>
                </div>
                <div> <label for="transaction-account">Conto:</label> <select id="transaction-account" required aria-describedby="transaction-account-error"> <option value="" disabled selected>-- Seleziona Conto --</option> </select> <p id="transaction-account-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div> <label for="transaction-description">Descrizione (Opzionale):</label> <input type="text" id="transaction-description" placeholder="Es: Cena da Mario..."> </div>
                <button type="submit" id="save-transaction-button" class="button primary-button"><i class="fas fa-save" aria-hidden="true"></i> Salva Transazione</button>
                <p id="transaction-modal-error" class="error-message form-error" aria-live="polite"></p>
            </form>
        </div>
    </div> <!-- Fine #transaction-modal -->

    <!-- Modal Obiettivo -->
    <div id="goal-modal" class="modal" aria-labelledby="goal-modal-title" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="close-button" aria-label="Chiudi finestra modale Obiettivo">√ó</button>
            <h2 id="goal-modal-title">Aggiungi Obiettivo</h2> <!-- Title changes via JS -->
            <form id="goal-form" novalidate>
                <input type="hidden" id="goal-id"> <!-- ID will be set here for edits -->
                <div> <label for="goal-name">Nome Obiettivo:</label> <input type="text" id="goal-name" required aria-describedby="goal-name-error"> <p id="goal-name-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div> <label for="goal-target-amount">Importo Obiettivo (‚Ç¨):</label> <input type="number" id="goal-target-amount" step="0.01" required min="0.01" placeholder="Es: 1500.00" aria-describedby="goal-target-amount-error"> <p id="goal-target-amount-error" class="error-message field-error" aria-live="polite"></p> </div>
                <button type="submit" class="button primary-button"><i class="fas fa-save" aria-hidden="true"></i> Salva Obiettivo</button>
                <p id="goal-modal-error" class="error-message form-error" aria-live="polite"></p>
            </form>
        </div>
    </div> <!-- Fine #goal-modal -->

     <!-- Modal Categoria -->
    <div id="category-modal" class="modal" aria-labelledby="category-modal-title" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="close-button" aria-label="Chiudi finestra modale Categoria">√ó</button>
            <h2 id="category-modal-title">Aggiungi Categoria</h2> <!-- Title changes via JS -->
            <form id="category-form" novalidate>
                <input type="hidden" id="category-id"> <!-- ID will be set here for edits -->
                <input type="hidden" id="category-parent-id"> <!-- NEW: Parent ID for subcategories -->
                <div> <label for="category-name">Nome Categoria/Sottocategoria:</label> <input type="text" id="category-name" required aria-describedby="category-name-error"> <p id="category-name-error" class="error-message field-error" aria-live="polite"></p> </div>
                 <!-- Parent info shown when adding/editing subcategory -->
                <div id="parent-category-info" style="display: none;">
                    <p>Sottocategoria di: <strong id="parent-category-name"></strong></p>
                </div>
                <button type="submit" class="button primary-button"><i class="fas fa-save" aria-hidden="true"></i> Salva</button>
                <p id="category-modal-error" class="error-message form-error" aria-live="polite"></p>
            </form>
        </div>
    </div> <!-- Fine #category-modal -->

    <!-- NEW: Modal Giroconto -->
    <div id="transfer-modal" class="modal" aria-labelledby="transfer-modal-title" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="close-button" aria-label="Chiudi finestra modale Giroconto">√ó</button>
            <h2 id="transfer-modal-title"><i class="fas fa-random" aria-hidden="true"></i> Nuovo Giroconto</h2>
            <form id="transfer-form" novalidate>
                <div> <label for="transfer-date">Data:</label> <input type="date" id="transfer-date" required aria-describedby="transfer-date-error"> <p id="transfer-date-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div> <label for="transfer-amount">Importo (‚Ç¨):</label> <input type="number" id="transfer-amount" step="0.01" required min="0.01" placeholder="Es: 100.00" aria-describedby="transfer-amount-error"> <p id="transfer-amount-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div> <label for="transfer-from-account">Da Conto:</label> <select id="transfer-from-account" required aria-describedby="transfer-from-account-error"> <option value="" disabled selected>-- Seleziona Conto Origine --</option> </select> <p id="transfer-from-account-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div> <label for="transfer-to-account">A Conto:</label> <select id="transfer-to-account" required aria-describedby="transfer-to-account-error"> <option value="" disabled selected>-- Seleziona Conto Destinazione --</option> </select> <p id="transfer-to-account-error" class="error-message field-error" aria-live="polite"></p> </div>
                <div> <label for="transfer-description">Descrizione (Opzionale):</label> <input type="text" id="transfer-description" placeholder="Es: Trasferimento risparmi..."> </div>
                <button type="submit" class="button primary-button"><i class="fas fa-check" aria-hidden="true"></i> Esegui Giroconto</button>
                <p id="transfer-modal-error" class="error-message form-error" aria-live="polite"></p>
            </form>
        </div>
    </div> <!-- Fine #transfer-modal -->


    <!-- Modal Impostazioni -->
    <div id="settings-modal" class="modal" aria-labelledby="settings-modal-title" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="close-button" aria-label="Chiudi finestra modale Impostazioni">√ó</button>
            <h2 id="settings-modal-title"><i class="fas fa-cog" aria-hidden="true"></i> Impostazioni</h2>

            <!-- Sezione Sicurezza -->
            <div class="settings-section">
                <h3><i class="fas fa-key" aria-hidden="true"></i> Sicurezza</h3>
                <div class="setting-item">
                    <label for="change-pin-input">Cambia PIN (4 cifre):</label>
                    <div class="pin-change-controls">
                        <input type="password" id="change-pin-input" maxlength="4" placeholder="Nuovo PIN" inputmode="numeric" autocomplete="new-password" aria-describedby="pin-change-error pin-change-message"/>
                        <button id="change-pin-button" class="button secondary-button pin-change-button" aria-label="Conferma cambio PIN">
                            <i class="fas fa-check" aria-hidden="true"></i> <span class="button-text">Cambia</span>
                        </button>
                    </div>
                    <p id="pin-change-message" class="success-message" aria-live="polite"></p>
                    <p id="pin-change-error" class="error-message" aria-live="polite"></p>
                </div>
            </div> <!-- Fine Sicurezza -->

            <!-- Sezione Gestione Categorie -->
             <div class="settings-section">
                <h3><i class="fas fa-tags" aria-hidden="true"></i> Gestione Categorie</h3>
                 <div class="setting-item">
                    <!-- Modified: Button to add only MAIN category here -->
                    <div class="category-actions">
                        <button id="add-main-category-btn" class="button primary-button small-button"> <i class="fas fa-plus" aria-hidden="true"></i> Nuova Categoria Principale </button>
                    </div>
                    <h4 id="existing-categories-heading">Categorie Esistenti:</h4>
                    <ul id="categories-list-modal" class="data-list settings-list" aria-labelledby="existing-categories-heading" aria-live="polite" aria-relevant="additions removals">
                        <li class="list-item-placeholder" style="display: none;">Nessuna categoria.</li>
                        <!-- Items will be hierarchical now -->
                    </ul>
                 </div>
            </div> <!-- Fine Categorie -->

            <!-- Sezione Gestione Dati -->
            <div class="settings-section">
                <h3><i class="fas fa-database" aria-hidden="true"></i> Gestione Dati</h3>
                <p class="text-muted small">Esporta per backup o importa da file JSON/CSV.</p>
                <div class="setting-item data-actions">
                    <button id="export-json-button" class="button" title="Esporta tutto (JSON)"> <i class="fas fa-download" aria-hidden="true"></i> Esporta (JSON) </button>
                    <button id="import-json-button" class="button" title="Importa tutto da JSON (SOSTITUISCE DATI)"> <i class="fas fa-upload" aria-hidden="true"></i> Importa (JSON) </button>
                    <input type="file" id="import-json-input" accept=".json,application/json" class="hidden-input" aria-label="Seleziona file JSON">
                    <button id="export-csv-button" class="button" title="Esporta transazioni (CSV)"> <i class="fas fa-file-csv" aria-hidden="true"></i> Esporta (CSV) </button>
                    <button id="import-csv-button" class="button" title="Importa transazioni da CSV (AGGIUNGE DATI)"> <i class="fas fa-file-csv" aria-hidden="true"></i> Importa (CSV) </button>
                    <input type="file" id="import-csv-input" accept=".csv, text/csv, application/vnd.ms-excel" class="hidden-input" aria-label="Seleziona file CSV">
                </div>
                <p id="csv-import-error" class="error-message form-error" aria-live="polite"></p>
                <p id="csv-import-success" class="success-message form-error" aria-live="polite"></p>
                 <!-- Backup Reminder Info (Static Text) -->
                 <p class="text-muted small" style="margin-top: 15px;">
                    <i class="fas fa-info-circle"></i> Verr√† visualizzato un promemoria se non si effettua un backup (Esporta JSON) per pi√π di 30 giorni.
                </p>
            </div> <!-- Fine Dati -->

            <!-- Sezione Azioni Pericolose -->
             <div class="settings-section">
                <h3><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Azioni Pericolose</h3>
                 <div class="setting-item">
                    <p><strong>Attenzione:</strong> Azione irreversibile!</p>
                    <button id="reset-data-button" class="button danger-button"> <i class="fas fa-trash-alt" aria-hidden="true"></i> Reset Completo App </button>
                    <p class="text-muted small">Consigliato backup prima di procedere.</p>
                 </div>
            </div> <!-- Fine Azioni Pericolose -->
        </div>
    </div> <!-- Fine #settings-modal -->

<!-- FINE PARTE 3 -->
 <!-- INIZIO PARTE 4 -->
    <!-- JS -->
    <script defer>
        // --- Start PART 1 ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Constants ---
            const APP_VERSION = "1.3.0"; // Updated version for subcategories, transfers, backup reminder
            const DEFAULT_PIN = '1234';
            const DEBOUNCE_DELAY = 300;
            const BACKUP_REMINDER_DAYS = 30; // Show reminder after 30 days
            // Special Category IDs for Transfers
            const TRANSFER_OUT_CATEGORY_ID = 'cat_transfer_out';
            const TRANSFER_IN_CATEGORY_ID = 'cat_transfer_in';

            // --- DOM Elements Cache ---
            const elements = {
                body: document.body,
                loginSection: document.getElementById('login-section'),
                appContent: document.getElementById('app-content'),
                pinInput: document.getElementById('pin-input'),
                loginButton: document.getElementById('login-button'),
                loginError: document.getElementById('login-error'),
                accountsList: document.getElementById('accounts-list'),
                transactionsList: document.getElementById('transactions-list'),
                savingsGoalsList: document.getElementById('savings-goals-list'),
                categoriesListModal: document.getElementById('categories-list-modal'),
                filterAccountSelect: document.getElementById('filter-account'),
                filterCategorySelect: document.getElementById('filter-category'),
                searchTransactionInput: document.getElementById('search-transaction-input'),
                transactionAccountSelect: document.getElementById('transaction-account'),
                transactionCategorySelect: document.getElementById('transaction-category'),
                noCategoriesWarning: document.getElementById('no-categories-warning'),
                saveTransactionButton: document.getElementById('save-transaction-button'),
                incomeCategoryChartCanvas: document.getElementById('income-category-chart'),
                expenseCategoryChartCanvas: document.getElementById('expense-category-chart'),
                totalIncomeDisplay: document.getElementById('total-income-display'),
                totalExpenseDisplay: document.getElementById('total-expense-display'),
                currentYearSpan: document.getElementById('current-year'),
                themeIcon: document.getElementById('theme-icon'),
                settingsButton: document.getElementById('settings-button'),
                addAccountBtn: document.getElementById('add-account-btn'),
                addTransactionBtn: document.getElementById('add-transaction-btn'),
                addTransferBtn: document.getElementById('add-transfer-btn'), // New transfer button
                addGoalBtn: document.getElementById('add-goal-btn'),
                settingsModal: document.getElementById('settings-modal'),
                accountModal: document.getElementById('account-modal'),
                transactionModal: document.getElementById('transaction-modal'),
                transferModal: document.getElementById('transfer-modal'), // New transfer modal
                goalModal: document.getElementById('goal-modal'),
                categoryModal: document.getElementById('category-modal'),
                accountForm: document.getElementById('account-form'),
                transactionForm: document.getElementById('transaction-form'),
                transferForm: document.getElementById('transfer-form'), // New transfer form
                goalForm: document.getElementById('goal-form'),
                categoryForm: document.getElementById('category-form'),
                accountModalTitle: document.getElementById('account-modal-title'),
                transactionModalTitle: document.getElementById('transaction-modal-title'),
                // transferModalTitle: document.getElementById('transfer-modal-title'), // Already static
                goalModalTitle: document.getElementById('goal-modal-title'),
                categoryModalTitle: document.getElementById('category-modal-title'),
                parentCategoryInfo: document.getElementById('parent-category-info'), // For category modal
                parentCategoryName: document.getElementById('parent-category-name'), // For category modal
                addMainCategoryBtn: document.getElementById('add-main-category-btn'), // New button in settings
                categoryFiltersContainer: document.getElementById('category-filters-container'),
                incomeCategoryFilters: document.getElementById('income-category-filters'),
                expenseCategoryFilters: document.getElementById('expense-category-filters'),
                backupReminder: document.getElementById('backup-reminder'), // Backup reminder banner
                backupReminderExportBtn: document.getElementById('backup-reminder-export-btn'),
                backupReminderDismissBtn: document.getElementById('backup-reminder-dismiss-btn'),
            };

            // --- Chart instances ---
            let incomeCategoryChart, expenseCategoryChart;

            // --- Application State ---
            let storedPin = null;
            let accounts = [];
            let transactions = [];
            let categories = []; // Will store objects { id: string, name: string, parentId: string | null }
            let savingsGoals = [];
            let selectedIncomeCategories = []; // Stores *MAIN* category names for filtering charts/totals
            let selectedExpenseCategories = []; // Stores *MAIN* category names for filtering charts/totals
            let lastBackupTimestamp = 0; // Timestamp of last export

            // --- Utility Functions ---
            /** Formats a number as EUR currency. */
            function formatCurrency(amount) {
                let numAmount = typeof amount === 'string' ? parseFloat(amount.replace(',', '.')) : amount;
                if (typeof numAmount !== 'number' || isNaN(numAmount)) {
                    numAmount = 0;
                }
                return numAmount.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
            }

            /** Retrieves data from localStorage. */
            function getStoredData(key, defaultValue = []) {
                const data = localStorage.getItem(key);
                if (data === null) {
                     // Special case: Initialize lastBackupTimestamp if not found
                    if (key === 'lastBackupTimestamp') return 0;
                    return defaultValue;
                }
                try {
                    const parsedData = JSON.parse(data);
                    // Basic type validation
                    if (Array.isArray(defaultValue) && !Array.isArray(parsedData)) return defaultValue;
                    if (typeof defaultValue === 'object' && !Array.isArray(defaultValue) && defaultValue !== null && (typeof parsedData !== 'object' || parsedData === null)) return defaultValue;
                    if (typeof defaultValue === 'number' && typeof parsedData !== 'number') return defaultValue;
                    if (typeof defaultValue === 'string' && typeof parsedData !== 'string') return defaultValue;

                    // Specific data validation/migration (Example)
                    if (key === 'categories' && Array.isArray(parsedData)) {
                        // Ensure categories have id, name, and potentially parentId (null if missing)
                        return parsedData.map(cat => ({
                            id: cat.id || `cat_mig_${Date.now()}_${Math.random().toString(16).slice(2)}`, // Generate ID if missing
                            name: cat.name || 'Senza Nome',
                            parentId: cat.parentId || null // Add parentId if missing
                        })).filter(cat => cat.id && cat.name);
                    }
                    if (key === 'transactions' && Array.isArray(parsedData)) {
                        // Ensure transactions have categoryId (migrate from old 'category' name if needed) and valid amounts/dates
                        return parsedData.map(t => {
                            let categoryId = t.categoryId;
                            // Migration: If old 'category' (name) exists and categoryId doesn't, find ID
                            if (!categoryId && t.category && typeof t.category === 'string') {
                                const foundCat = categories.find(c => c.name === t.category);
                                categoryId = foundCat ? foundCat.id : null; // Assign found ID or null
                                if (foundCat) console.warn(`Migrated transaction ${t.id || 'N/A'}: category name "${t.category}" mapped to ID "${categoryId}".`);
                                else console.error(`Migration failed for transaction ${t.id || 'N/A'}: category name "${t.category}" not found.`);
                            }
                            // Handle transfers specifically
                            if (categoryId === TRANSFER_OUT_CATEGORY_ID || categoryId === TRANSFER_IN_CATEGORY_ID) {
                                // Ensure transferId exists for transfers
                                if (!t.transferId) {
                                    t.transferId = `trf_${t.id || Date.now()}`; // Generate a related transfer ID if missing
                                    console.warn(`Generating missing transferId for transfer transaction ${t.id}: ${t.transferId}`);
                                }
                            }

                            return {
                                ...t,
                                id: t.id || `txn_mig_${Date.now()}_${Math.random().toString(16).slice(2)}`,
                                amount: parseFloat(t.amount) || 0,
                                date: t.date && !isNaN(new Date(t.date)) ? t.date : new Date().toISOString().slice(0, 10),
                                categoryId: categoryId || null, // Store ID or null
                                transferId: t.transferId || null // Keep or add transferId
                            };
                        }).filter(t => t.id && t.account && t.categoryId); // Ensure essential fields exist
                    }
                    return parsedData;
                } catch (error) {
                    console.error(`Error parsing data for key "${key}":`, error);
                    // Return defaults for critical data, handle others specifically
                    if (['accounts', 'transactions', 'categories', 'savingsGoals'].includes(key)) return defaultValue;
                    if (key === 'pin') return DEFAULT_PIN;
                    if (key === 'theme') return 'light';
                    if (key === 'lastBackupTimestamp') return 0;
                    return defaultValue;
                }
            }


            /** Stores data in localStorage and updates state. */
            function storeData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    switch(key) {
                        case 'accounts': accounts = Array.isArray(data) ? [...data] : []; break;
                        case 'transactions': transactions = Array.isArray(data) ? [...data] : []; break;
                        case 'categories': categories = Array.isArray(data) ? [...data] : []; break;
                        case 'savingsGoals': savingsGoals = Array.isArray(data) ? [...data] : []; break;
                        case 'pin': storedPin = data; break;
                        case 'theme': /* state updated in setTheme */ break;
                        case 'lastBackupTimestamp': lastBackupTimestamp = data; break;
                    }
                    console.log(`Data stored for key "${key}". Current state:`, key === 'lastBackupTimestamp' ? new Date(data).toLocaleString() : (Array.isArray(data) ? data.length : 'N/A'));
                } catch (error) {
                    console.error(`Error saving data for key "${key}":`, error);
                    // Avoid alert for theme errors as they are less critical
                    if (key !== 'theme') {
                        displayAppError(`Errore durante il salvataggio dei dati (${key}).`);
                    }
                }
            }


            /** Loads all data from storage into state variables. */
            function loadAllDataFromStorage() {
                 // Load categories first, as transaction migration might depend on it
                categories = getStoredData('categories', []);
                accounts = getStoredData('accounts', []);
                transactions = getStoredData('transactions', []); // This now performs migration if needed
                savingsGoals = getStoredData('savingsGoals', []);
                storedPin = getStoredData('pin', DEFAULT_PIN);
                lastBackupTimestamp = getStoredData('lastBackupTimestamp', 0);
                console.log("Data loaded from storage.");

                // Ensure default categories exist if none loaded (and no transfers)
                if (categories.length === 0) {
                    console.warn("No categories found, adding defaults.");
                    const defaultCategories = [
                        { id: 'cat_stipendio_init', name: 'Stipendio', parentId: null },
                        { id: 'cat_spesa_init', name: 'Spesa', parentId: null },
                        { id: 'sub_spesa_alimentari_init', name: 'Alimentari', parentId: 'cat_spesa_init' },
                        { id: 'cat_trasporti_init', name: 'Trasporti', parentId: null },
                        { id: 'cat_casa_init', name: 'Casa', parentId: null },
                        { id: 'sub_casa_affitto_init', name: 'Affitto/Mutuo', parentId: 'cat_casa_init' },
                        { id: 'cat_svago_init', name: 'Svago', parentId: null }
                    ];
                    storeData('categories', defaultCategories);
                }
                 // Ensure special transfer categories exist (cannot be deleted by user)
                addSpecialTransferCategories();
            }

             /** Adds special, non-deletable categories for transfers if they don't exist */
             function addSpecialTransferCategories() {
                let changed = false;
                const transferOutExists = categories.some(c => c.id === TRANSFER_OUT_CATEGORY_ID);
                const transferInExists = categories.some(c => c.id === TRANSFER_IN_CATEGORY_ID);

                if (!transferOutExists) {
                    categories.push({ id: TRANSFER_OUT_CATEGORY_ID, name: "Giroconto (Uscita)", parentId: null });
                    changed = true;
                    console.log("Added special category: Giroconto (Uscita)");
                }
                if (!transferInExists) {
                    categories.push({ id: TRANSFER_IN_CATEGORY_ID, name: "Giroconto (Entrata)", parentId: null });
                    changed = true;
                    console.log("Added special category: Giroconto (Entrata)");
                }

                if (changed) {
                    storeData('categories', categories);
                }
            }


            /** Displays an application-level error. */
            function displayAppError(message) {
                console.error("APP ERROR:", message);
                alert(`Errore Applicazione:\n${message}\n\nControlla la console per dettagli.`);
            }

            /** Opens a modal dialog, managing form reset and focus. */
            function openModal(modalId, isEditing = false, modalTitleElement = null, editTitle = 'Modifica Elemento', contextData = null) {
                const modal = document.getElementById(modalId);
                if (!modal) {
                    console.error(`Modal with ID "${modalId}" not found.`);
                    return;
                }
                const form = modal.querySelector('form');
                clearErrorMessages(modal); // Clear errors outside the form first

                if (form) {
                    clearErrorMessages(form); // Clear errors inside the form
                    const hiddenIdInput = form.querySelector('input[type="hidden"][id$="-id"]'); // General ID
                    const hiddenParentIdInput = form.querySelector('#category-parent-id'); // Specific for category
                    const parentInfoDiv = form.querySelector('#parent-category-info'); // Specific for category
                    const parentNameSpan = form.querySelector('#parent-category-name'); // Specific for category

                    if (!isEditing) {
                        console.log(`Opening modal ${modalId} for ADD.`);
                        form.reset(); // Reset form fields
                        if (hiddenIdInput) hiddenIdInput.value = ''; // Clear main ID
                        if (hiddenParentIdInput) hiddenParentIdInput.value = contextData?.parentId || ''; // Set parent ID from context if adding subcat
                        if (parentInfoDiv && parentNameSpan) {
                             if (contextData?.parentId) {
                                 const parentCat = findCategoryById(contextData.parentId);
                                 parentNameSpan.textContent = parentCat ? parentCat.name : 'Sconosciuto';
                                 parentInfoDiv.style.display = 'block';
                                 if (modalTitleElement) modalTitleElement.textContent = 'Aggiungi Sottocategoria';
                             } else {
                                 parentInfoDiv.style.display = 'none';
                                 if (modalId === 'category-modal' && modalTitleElement) modalTitleElement.textContent = 'Aggiungi Categoria Principale';
                             }
                        }

                        // Specific defaults for other modals on ADD
                        if (modalId === 'account-modal') {
                            if (modalTitleElement) modalTitleElement.textContent = 'Aggiungi Conto';
                            const colorInput = modal.querySelector('#account-color');
                            if (colorInput) { const defaultColors = ['#4CAF50', '#2196F3', '#FFC107', '#9C27B0', '#FF5722', '#00BCD4', '#8BC34A', '#03A9F4', '#FF9800', '#673AB7']; colorInput.value = defaultColors[Math.floor(Math.random() * defaultColors.length)]; }
                            const balanceInput = modal.querySelector('#account-initial-balance');
                            if(balanceInput) balanceInput.value = '0.00';
                        } else if (modalId === 'transaction-modal') {
                            if (modalTitleElement) modalTitleElement.textContent = 'Aggiungi Transazione';
                            const dateInput = modal.querySelector('#transaction-date');
                            if(dateInput) dateInput.valueAsDate = new Date();
                            if (accounts.length === 1) { const accSelect = modal.querySelector('#transaction-account'); if (accSelect) accSelect.value = accounts[0].id; }
                            toggleNoCategoriesWarning(); // Check if categories exist
                        } else if (modalId === 'goal-modal') {
                             if (modalTitleElement) modalTitleElement.textContent = 'Aggiungi Obiettivo';
                        } else if (modalId === 'transfer-modal') {
                            if (modalTitleElement) modalTitleElement.textContent = 'Nuovo Giroconto';
                             const dateInput = modal.querySelector('#transfer-date');
                            if(dateInput) dateInput.valueAsDate = new Date();
                        }

                    } else { // Editing mode
                         console.log(`Opening modal ${modalId} for EDIT.`);
                         if (modalTitleElement) modalTitleElement.textContent = editTitle;
                         // Handle editing subcategory display info
                         if (modalId === 'category-modal' && parentInfoDiv && parentNameSpan) {
                             const parentId = hiddenParentIdInput ? hiddenParentIdInput.value : null;
                             if (parentId) {
                                 const parentCat = findCategoryById(parentId);
                                 parentNameSpan.textContent = parentCat ? parentCat.name : 'Sconosciuto';
                                 parentInfoDiv.style.display = 'block';
                             } else {
                                 parentInfoDiv.style.display = 'none';
                             }
                         }
                         if (modalId === 'transaction-modal') toggleNoCategoriesWarning();
                    }
                } else { // Modals without forms (like settings)
                    clearErrorMessages(modal);
                    if (modalId === 'settings-modal' && modalTitleElement) modalTitleElement.textContent = 'Impostazioni';
                }

                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
                const firstInput = modal.querySelector('input:not([type="hidden"]):not([type="color"]), select, textarea, button.close-button');
                if (firstInput) { setTimeout(() => firstInput.focus(), 50); }
            }


            /** Closes an active modal dialog. */
            function closeModal(modal) {
                if (modal && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                     const titleEl = modal.querySelector('h2[id$="-modal-title"]');
                     if (titleEl) {
                         const baseTitle = titleEl.id.replace(/-modal-title$/, '');
                         // Reset titles, handle category modal specifically
                         switch(baseTitle) {
                            case 'account': titleEl.textContent = 'Aggiungi Conto'; break;
                            case 'transaction': titleEl.textContent = 'Aggiungi Transazione'; break;
                            case 'goal': titleEl.textContent = 'Aggiungi Obiettivo'; break;
                            case 'category': titleEl.textContent = 'Aggiungi Categoria'; break; // Default reset
                            case 'transfer': titleEl.textContent = 'Nuovo Giroconto'; break;
                         }
                     }
                      // Reset parent info in category modal specifically
                     if (modal.id === 'category-modal') {
                        const parentInfoDiv = modal.querySelector('#parent-category-info');
                        const parentIdInput = modal.querySelector('#category-parent-id');
                        if (parentInfoDiv) parentInfoDiv.style.display = 'none';
                        if (parentIdInput) parentIdInput.value = '';
                    }
                }
            }

            /** Clears error/success messages and aria-invalid attributes within a container. */
            function clearErrorMessages(container) {
                if (!container) return;
                container.querySelectorAll('.error-message, .success-message').forEach(el => {
                    el.textContent = '';
                    // Keep base classes, remove specific status classes
                    el.classList.remove('success-message', 'error-message');
                });
                container.querySelectorAll('[aria-invalid="true"]').forEach(el => {
                    el.removeAttribute('aria-invalid');
                });
            }


            /** Shows a message (error or success) associated with a form field. */
            function showFieldMessage(fieldId, message, isSuccess = false) {
                const activeModal = document.querySelector('.modal.active');
                const container = activeModal || document;
                const errorElementId = `${fieldId}-error`; // e.g., account-name-error
                const messageElement = container.querySelector(`#${errorElementId}`);

                if (messageElement) {
                    messageElement.textContent = message;
                    // Ensure base classes are present if needed (like 'field-error')
                    messageElement.classList.remove('success-message', 'error-message'); // Clear previous status
                    if (message) { // Add status class only if there's a message
                         messageElement.classList.add(isSuccess ? 'success-message' : 'error-message');
                    }
                } else {
                    console.warn(`Message element for field "${fieldId}" (ID: ${errorElementId}) not found.`);
                    // Fallback to general form error display
                    const formErrorEl = activeModal?.querySelector('.form-error'); // General error P tag at form bottom
                    if (formErrorEl) {
                        formErrorEl.textContent = `${message} (Campo: ${fieldId})`;
                        formErrorEl.className = 'error-message form-error'; // Set class for styling
                    } else {
                         // Ultimate fallback: use app-level alert
                        displayAppError(`${message} (Campo: ${fieldId}) - Elemento errore non trovato.`);
                    }
                }
            }


            /** Validates form fields within a container based on rules. */
            function validateForm(containerElement, rules) {
                if (!containerElement) return false;
                clearErrorMessages(containerElement);
                let isValid = true;
                for (const fieldId in rules) {
                    const input = containerElement.querySelector(`#${fieldId}`);
                    if (!input) { console.warn(`Validation skipped: Field "${fieldId}" not found.`); continue; }
                    const value = input.type === 'number' ? input.value : input.value.trim(); // Trim only non-numeric types
                    const ruleSet = rules[fieldId].split('|');
                    let fieldValid = true;
                    for (const rule of ruleSet) {
                        if (!fieldValid) break; // Stop checking rules for this field if one failed
                        const ruleParts = rule.split(':'); // For rules like min:0.01
                        const ruleName = ruleParts[0];
                        const ruleParam = ruleParts[1];

                        switch (ruleName) {
                            case 'required':
                                if (!value) {
                                    showFieldMessage(fieldId, 'Questo campo √® obbligatorio.');
                                    isValid = false; fieldValid = false;
                                }
                                break;
                            case 'number':
                                if (value && isNaN(Number(value.replace(',', '.')))) {
                                    showFieldMessage(fieldId, 'Deve essere un numero valido.');
                                    isValid = false; fieldValid = false;
                                }
                                break;
                            case 'positive':
                                if (value && Number(value.replace(',', '.')) <= 0) {
                                    showFieldMessage(fieldId, 'Deve essere un numero positivo (> 0).');
                                    isValid = false; fieldValid = false;
                                }
                                break;
                             case 'min':
                                if (value && Number(value.replace(',', '.')) < Number(ruleParam)) {
                                    showFieldMessage(fieldId, `Il valore minimo √® ${ruleParam}.`);
                                    isValid = false; fieldValid = false;
                                }
                                break;
                            case 'pin':
                                if (!value || value.length !== 4 || !/^\d{4}$/.test(value)) {
                                    showFieldMessage(fieldId, 'Il PIN deve essere di 4 cifre.');
                                    isValid = false; fieldValid = false;
                                }
                                break;
                            case 'differentFrom': // Example: #transfer-to-account:differentFrom:#transfer-from-account
                                const otherField = containerElement.querySelector(ruleParam);
                                if (otherField && value && value === otherField.value) {
                                     // Get label text for better message
                                    const fieldLabel = containerElement.querySelector(`label[for="${fieldId}"]`)?.textContent || fieldId;
                                    const otherLabel = containerElement.querySelector(`label[for="${otherField.id}"]`)?.textContent || ruleParam;
                                    showFieldMessage(fieldId, `${fieldLabel} deve essere diverso da ${otherLabel}.`);
                                    isValid = false; fieldValid = false;
                                }
                                break;
                        }
                    }
                    input.setAttribute('aria-invalid', !fieldValid);
                }
                return isValid;
            }


            /** Debounce function. */
            function debounce(func, delay) { let timeoutId; return function(...args) { clearTimeout(timeoutId); timeoutId = setTimeout(() => { func.apply(this, args); }, delay); }; }

            // --- Theme Management ---
            function initializeTheme() {
                let currentTheme = getStoredData('theme', 'light');
                if (currentTheme !== 'light' && currentTheme !== 'dark') { currentTheme = 'light'; storeData('theme', currentTheme); }
                setTheme(currentTheme);
                const switcher = elements.themeIcon?.parentElement;
                 if (switcher && !switcher.dataset.listenerAttached) { // Ensure listener is attached only once
                    switcher.addEventListener('click', () => {
                        const newTheme = elements.body.classList.contains('dark-theme') ? 'light' : 'dark';
                        setTheme(newTheme);
                    });
                    switcher.dataset.listenerAttached = 'true'; // Mark as attached
                } else if (!switcher) {
                     console.warn("Theme switcher not found.");
                }
            }
            function setTheme(theme) {
                const validTheme = (theme === 'light' || theme === 'dark') ? theme : 'light';
                elements.body.classList.remove('light-theme', 'dark-theme');
                elements.body.classList.add(`${validTheme}-theme`);
                if(elements.themeIcon) {
                     const icon = elements.themeIcon;
                     // Use classList.replace for cleaner toggle
                    icon.classList.replace(validTheme === 'dark' ? 'fa-sun' : 'fa-moon', validTheme === 'dark' ? 'fa-moon' : 'fa-sun');
                     // Update title on the parent switcher element
                     if (icon.parentElement) {
                        icon.parentElement.title = `Passa a tema ${validTheme === 'dark' ? 'chiaro' : 'scuro'}`;
                    }
                }
                storeData('theme', validTheme);
                updateChartColors();
                renderCategoryFilters(); // Re-render filters to apply theme styles
            }


            // --- PIN Login ---
            /** Initializes PIN login. Hides Settings button. */
            function initializePinLogin() {
                if (storedPin === null) { storedPin = DEFAULT_PIN; }
                if (typeof storedPin !== 'string' || !/^\d{4}$/.test(storedPin)) { storedPin = DEFAULT_PIN; storeData('pin', storedPin); }
                if (storedPin === DEFAULT_PIN) { console.warn("Default PIN in use."); }

                if (elements.settingsButton) elements.settingsButton.style.display = 'none';
                if (elements.categoryFiltersContainer) elements.categoryFiltersContainer.style.display = 'none';
                if(elements.loginSection) elements.loginSection.style.display = 'flex';
                if(elements.appContent) elements.appContent.style.display = 'none';
                if(elements.pinInput) {
                     elements.pinInput.value = ''; elements.pinInput.type = 'password';
                     elements.pinInput.setAttribute('inputmode', 'numeric'); elements.pinInput.focus();
                } else { displayAppError("Campo PIN non trovato."); return; }
                setupLoginListeners();
            }

            /** Sets up login listeners. Shows Settings button on success. */
            function setupLoginListeners() {
                 if(!elements.loginButton || !elements.pinInput) return;
                 const handleLogin = () => {
                     if (elements.pinInput.value === storedPin) {
                        elements.loginSection.style.display = 'none';
                        elements.appContent.style.display = 'grid';
                        elements.loginError.textContent = '';
                        if (elements.settingsButton) elements.settingsButton.style.display = 'inline-flex';
                        loadInitialData();
                     } else {
                         elements.loginError.textContent = 'PIN errato.'; elements.pinInput.value = '';
                         elements.pinInput.focus(); elements.pinInput.classList.add('shake-error');
                         elements.pinInput.addEventListener('animationend', () => {
                             elements.pinInput.classList.remove('shake-error');
                         }, { once: true });
                     }
                 };
                 elements.loginButton.removeEventListener('click', handleLogin);
                 elements.pinInput.removeEventListener('keypress', handlePinKeyPress);
                 elements.loginButton.addEventListener('click', handleLogin);
                 elements.pinInput.addEventListener('keypress', handlePinKeyPress);
            }

             /** Handles keypress on PIN input. */
             function handlePinKeyPress(event) {
                 // Allow only digits, Enter, Backspace, Tab, Ctrl/Cmd combinations
                 if (!/\d/.test(event.key) && event.key !== 'Enter' && event.key !== 'Backspace' && event.key !== 'Tab' && !event.ctrlKey && !event.metaKey) {
                     event.preventDefault();
                 }
                 if (event.key === 'Enter') {
                    event.preventDefault();
                    elements.loginButton.click();
                 }
             }


            // --- Data Loading and Rendering ---
            /** Calculates account balance. */
            function calculateCurrentBalance(accountId) {
                const account = accounts.find(acc => acc.id === accountId);
                if (!account) return 0;
                const initialBalance = parseFloat(account.initialBalance) || 0;
                const transactionTotal = transactions
                    .filter(t => t.account === accountId)
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                return initialBalance + transactionTotal;
             }
            /** Renders a single account item. */
            function renderAccountItem(account) {
                const accountId = account.id; const accountName = account.name || 'Senza Nome'; const accountColor = account.color || '#ccc'; const currentBalance = calculateCurrentBalance(accountId); const li = document.createElement('li'); li.className = 'list-item account-item'; li.style.setProperty('--account-color', accountColor); li.dataset.accountId = accountId; li.innerHTML = `<div class="item-info"><h3 class="item-name">${accountName}</h3><p class="account-balance">Saldo: ${formatCurrency(currentBalance)}</p><small class="text-muted">Iniziale: ${formatCurrency(account.initialBalance)}</small></div><div class="item-actions"><button class="icon-button edit-button" data-id="${accountId}" aria-label="Modifica ${accountName}" title="Modifica"><i class="fas fa-edit"></i></button><button class="icon-button delete-button" data-id="${accountId}" aria-label="Elimina ${accountName}" title="Elimina"><i class="fas fa-trash-alt"></i></button></div>`; return li;
             }
            /** Loads and displays accounts. */
            function loadAccounts() {
                if (!elements.accountsList) return; const list = elements.accountsList; const placeholder = list.querySelector('.list-item-placeholder'); list.innerHTML = ''; if (accounts.length === 0) { if (placeholder) { placeholder.textContent = 'Nessun conto aggiunto.'; list.appendChild(placeholder); } else list.innerHTML = '<li class="list-item-placeholder">Nessun conto aggiunto.</li>'; } else { if (placeholder) placeholder.remove(); accounts.forEach(acc => list.appendChild(renderAccountItem(acc))); } if (placeholder) placeholder.style.display = accounts.length === 0 ? 'block' : 'none';
             }

             // --- Category Helper Functions ---
            /** Finds a category by its ID. */
            function findCategoryById(categoryId) {
                return categories.find(cat => cat.id === categoryId);
            }

            /** Gets the full path name of a category (e.g., "Spese > Auto > Benzina"). */
            function getCategoryPathName(categoryId) {
                const path = [];
                let currentCat = findCategoryById(categoryId);
                while (currentCat) {
                    path.unshift(currentCat.name); // Add to the beginning
                    currentCat = currentCat.parentId ? findCategoryById(currentCat.parentId) : null;
                }
                return path.join(' > ');
            }

             /** Gets the top-level parent category for a given category ID. */
            function getMainCategory(categoryId) {
                let currentCat = findCategoryById(categoryId);
                if (!currentCat) return null;
                while (currentCat.parentId) {
                    const parent = findCategoryById(currentCat.parentId);
                    if (!parent) break; // Should not happen in consistent data
                    currentCat = parent;
                }
                return currentCat;
            }

            /** Gets all subcategory IDs (recursive) for a given parent ID. */
            function getSubCategoryIds(parentId) {
                 let ids = [];
                 const directSubs = categories.filter(cat => cat.parentId === parentId);
                 directSubs.forEach(sub => {
                     ids.push(sub.id);
                     ids = ids.concat(getSubCategoryIds(sub.id)); // Recursively get children of children
                 });
                 return ids;
            }


            /** Renders a single transaction item. */
            function renderTransactionItem(transaction) {
                const { id, amount: rawAmount, categoryId, account: accountId, date: dateStr, description, transferId } = transaction;
                const amount = parseFloat(rawAmount) || 0;
                const date = dateStr ? new Date(dateStr) : null;
                const formattedDate = date ? date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Data Invalida';

                const account = accounts.find(a => a.id === accountId);
                const accountName = account?.name || 'Sconosciuto';
                const accountColor = account?.color || '#ccc';

                const isTransfer = categoryId === TRANSFER_OUT_CATEGORY_ID || categoryId === TRANSFER_IN_CATEGORY_ID;
                let categoryDisplay = '';
                let amountClass = '';

                if (isTransfer) {
                    amountClass = 'transfer';
                    // Find the counterpart transaction
                    const counterpart = transactions.find(t => t.transferId === transferId && t.id !== id);
                    const counterpartAccount = counterpart ? accounts.find(a => a.id === counterpart.account) : null;
                    const counterpartAccountName = counterpartAccount?.name || 'Conto Sconosciuto';
                    if (categoryId === TRANSFER_OUT_CATEGORY_ID) {
                        categoryDisplay = `<span class="category-path">Giroconto <i class="fas fa-long-arrow-alt-right"></i> ${counterpartAccountName}</span>`;
                    } else { // TRANSFER_IN
                        categoryDisplay = `<span class="category-path">Giroconto <i class="fas fa-long-arrow-alt-left"></i> ${counterpartAccountName}</span>`;
                    }
                } else {
                    amountClass = amount < 0 ? 'expense' : (amount > 0 ? 'income' : ''); // Empty class if amount is 0
                    const categoryPath = getCategoryPathName(categoryId);
                    categoryDisplay = categoryPath || 'Non Categorizzato';
                }

                 const li = document.createElement('li');
                 li.className = 'list-item transaction-item';
                 li.dataset.transactionId = id;
                 if (isTransfer) li.dataset.transferId = transferId; // Add transfer ID for potential linking/styling

                 li.innerHTML = `
                    <div class="item-info transaction-details">
                        <p class="transaction-amount ${amountClass}">${formatCurrency(amount)}</p>
                        <p class="transaction-description">${description || (isTransfer ? 'Giroconto' : categoryDisplay.split(' > ').pop())}</p> <!-- Show description or last part of category path -->
                        <p class="transaction-meta">
                            <span><i class="far fa-calendar-alt"></i> ${formattedDate}</span> |
                            <span><i class="fas ${isTransfer ? 'fa-random' : 'fa-tag'}"></i> ${categoryDisplay}</span> |
                            <span><i class="fas fa-wallet" style="color:${accountColor};"></i> ${accountName}</span>
                        </p>
                    </div>
                    <div class="item-actions">
                        ${!isTransfer ? `<button class="icon-button edit-button" data-id="${id}" aria-label="Modifica transazione" title="Modifica"><i class="fas fa-edit"></i></button>` : ''} <!-- No edit for transfers for now -->
                        <button class="icon-button delete-button" data-id="${id}" aria-label="Elimina ${isTransfer ? 'giroconto' : 'transazione'}" title="Elimina"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                 return li;
             }

            /** Loads and displays transactions based on filters/search. */
            function loadTransactions() {
                if (!elements.transactionsList || !elements.filterAccountSelect || !elements.filterCategorySelect || !elements.searchTransactionInput) return;
                const list = elements.transactionsList;
                const placeholder = list.querySelector('.list-item-placeholder');
                list.innerHTML = ''; // Clear previous items

                const selectedAccountId = elements.filterAccountSelect.value;
                const selectedFilterCategoryId = elements.filterCategorySelect.value; // This can be main or subcategory ID
                const searchTerm = elements.searchTransactionInput.value.toLowerCase().trim();

                const filtered = transactions.filter(t => {
                    // Filter by Account
                    if (selectedAccountId && t.account !== selectedAccountId) return false;

                    // Filter by Category (Main or Sub)
                    if (selectedFilterCategoryId) {
                        const isMainCatSelected = !findCategoryById(selectedFilterCategoryId)?.parentId; // Check if it's a main category
                        if (isMainCatSelected) {
                            // If main category selected, include all its subcategories
                            const mainCat = findCategoryById(selectedFilterCategoryId);
                             if (mainCat && mainCat.id !== TRANSFER_IN_CATEGORY_ID && mainCat.id !== TRANSFER_OUT_CATEGORY_ID) { // Exclude transfers from main category filtering
                                const allowedCategoryIds = [selectedFilterCategoryId, ...getSubCategoryIds(selectedFilterCategoryId)];
                                if (!allowedCategoryIds.includes(t.categoryId)) return false;
                            } else if (mainCat && (mainCat.id === TRANSFER_IN_CATEGORY_ID || mainCat.id === TRANSFER_OUT_CATEGORY_ID)) {
                                 // If a transfer category is selected directly, only show those
                                if (t.categoryId !== selectedFilterCategoryId) return false;
                             } else if (!mainCat) { // Should not happen if select is populated correctly
                                 return false;
                             }
                        } else {
                            // If subcategory selected, match exact ID
                             if (t.categoryId !== selectedFilterCategoryId) return false;
                        }
                    }

                    // Filter by Search Term
                    if (searchTerm) {
                        const descMatch = t.description?.toLowerCase().includes(searchTerm);
                        const catPath = getCategoryPathName(t.categoryId)?.toLowerCase(); // Search in full category path
                        const catMatch = catPath?.includes(searchTerm);
                        const amountStr = t.amount?.toString().replace('.', ',');
                        const amountMatch = amountStr?.includes(searchTerm.replace('.', ','));
                        const accountName = accounts.find(a => a.id === t.account)?.name.toLowerCase();
                        const accountMatch = accountName?.includes(searchTerm);
                        if (!descMatch && !catMatch && !amountMatch && !accountMatch) return false;
                    }

                    return true; // Passed all filters
                });

                filtered.sort((a, b) => (new Date(b.date) - new Date(a.date))); // Sort by date descending

                if (filtered.length === 0) {
                    if (placeholder) {
                        placeholder.textContent = (selectedAccountId || selectedFilterCategoryId || searchTerm)
                            ? `Nessuna transazione per i criteri selezionati${searchTerm ? ' ("'+elements.searchTransactionInput.value+'")' : ''}.`
                            : "Nessuna transazione aggiunta.";
                        list.appendChild(placeholder);
                        placeholder.style.display = 'block';
                    } else {
                        list.innerHTML = '<li class="list-item-placeholder">Nessuna transazione trovata.</li>';
                    }
                } else {
                    if (placeholder) placeholder.style.display = 'none';
                    filtered.forEach(t => list.appendChild(renderTransactionItem(t)));
                }
             }

            /** Renders a category item for settings, handling hierarchy. */
            function renderCategoryListItem(category, isSubcategory = false) {
                const { id, name } = category;
                const li = document.createElement('li');
                li.className = `list-item category-item ${isSubcategory ? 'category-item--sub' : 'category-item--main'}`;
                li.dataset.categoryId = id;

                 // Check if category can be deleted
                 const canDelete = canDeleteCategory(id);
                 const deleteDisabled = !canDelete.allowed ? 'disabled' : '';
                 const deleteTitle = !canDelete.allowed ? canDelete.reason : `Elimina ${name}`;

                 // Actions available
                 const actions = [
                     `<button class="icon-button edit-button" data-id="${id}" aria-label="Modifica ${name}" title="Modifica"><i class="fas fa-edit"></i></button>`,
                     // Add subcategory button only for main categories (and not transfers)
                     !isSubcategory && id !== TRANSFER_IN_CATEGORY_ID && id !== TRANSFER_OUT_CATEGORY_ID ? `<button class="icon-button add-subcategory-button" data-parent-id="${id}" aria-label="Aggiungi Sottocategoria a ${name}" title="Aggiungi Sottocategoria"><i class="fas fa-plus-circle"></i></button>` : '',
                     // Delete button (disabled if needed) - Cannot delete transfer categories
                     id !== TRANSFER_IN_CATEGORY_ID && id !== TRANSFER_OUT_CATEGORY_ID ? `<button class="icon-button delete-button" data-id="${id}" aria-label="${deleteTitle}" title="${deleteTitle}" ${deleteDisabled}><i class="fas fa-trash-alt"></i></button>` : ''
                 ].filter(Boolean).join(''); // Filter out empty strings and join

                 li.innerHTML = `
                    <div class="item-info"><span class="item-name">${name}</span></div>
                    <div class="item-actions">${actions}</div>`;
                 return li;
            }

            /** Loads categories hierarchically into settings modal. */
            function loadCategoriesForSettings() {
                if (!elements.categoriesListModal) return;
                const list = elements.categoriesListModal;
                const placeholder = list.querySelector('.list-item-placeholder');
                list.innerHTML = ''; // Clear existing items

                const mainCategories = categories.filter(cat => !cat.parentId).sort((a, b) => {
                     // Keep transfers at the bottom
                     if (a.id === TRANSFER_IN_CATEGORY_ID || a.id === TRANSFER_OUT_CATEGORY_ID) return 1;
                     if (b.id === TRANSFER_IN_CATEGORY_ID || b.id === TRANSFER_OUT_CATEGORY_ID) return -1;
                     return a.name.localeCompare(b.name);
                 });

                if (mainCategories.length === 0) {
                    if (placeholder) {
                        placeholder.textContent = "Nessuna categoria definita.";
                        list.appendChild(placeholder);
                         placeholder.style.display = 'block';
                    } else {
                        list.innerHTML = '<li class="list-item-placeholder">Nessuna categoria definita.</li>';
                    }
                } else {
                    if (placeholder) placeholder.style.display = 'none';
                    mainCategories.forEach(mainCat => {
                        list.appendChild(renderCategoryListItem(mainCat, false)); // Render main category
                        const subCategories = categories.filter(cat => cat.parentId === mainCat.id).sort((a, b) => a.name.localeCompare(b.name));
                        subCategories.forEach(subCat => {
                            list.appendChild(renderCategoryListItem(subCat, true)); // Render subcategory
                        });
                    });
                }
            }

            /** Renders a single goal item. */
            function renderGoalItem(goal) {
                const id = goal.id; const name = goal.name || 'Senza Nome'; const target = parseFloat(goal.targetAmount); const li = document.createElement('li'); li.className = 'list-item goal-item'; li.dataset.goalId = id; li.innerHTML = `<div class="item-info"><h3 class="item-name">${name}</h3><p class="goal-target">Obiettivo: ${formatCurrency(target)}</p></div><div class="item-actions"><button class="icon-button edit-button" data-id="${id}" aria-label="Modifica ${name}" title="Modifica"><i class="fas fa-edit"></i></button><button class="icon-button delete-button" data-id="${id}" aria-label="Elimina ${name}" title="Elimina"><i class="fas fa-trash-alt"></i></button></div>`; return li;
             }
            /** Loads and displays goals. */
            function loadSavingsGoals() {
                if (!elements.savingsGoalsList) return; const list = elements.savingsGoalsList; const placeholder = list.querySelector('.list-item-placeholder'); list.innerHTML = ''; if (savingsGoals.length === 0) { if (placeholder) { placeholder.textContent = 'Nessun obiettivo impostato.'; list.appendChild(placeholder); } else list.innerHTML = '<li class="list-item-placeholder">Nessun obiettivo impostato.</li>'; } else { if (placeholder) placeholder.remove(); savingsGoals.forEach(goal => list.appendChild(renderGoalItem(goal))); } if (placeholder) placeholder.style.display = savingsGoals.length === 0 ? 'block' : 'none';
             }
            /** Updates select dropdown options with hierarchy. */
            function updateSelectOptions() {
                const accountOptions = accounts.map(acc => new Option(acc.name || 'Senza Nome', acc.id));
                const categorySelects = [elements.filterCategorySelect, elements.transactionCategorySelect];
                const transferSelects = [elements.transferForm?.querySelector('#transfer-from-account'), elements.transferForm?.querySelector('#transfer-to-account')];

                // Populate Account Selects
                const populateAccountSelect = (selectEl, options, defaultVal = "", placeholderText = "Seleziona...") => {
                    if (!selectEl) return;
                    const currentVal = selectEl.value;
                    selectEl.innerHTML = '';
                    selectEl.add(new Option(placeholderText, defaultVal, defaultVal === "", defaultVal === ""));
                    if (defaultVal === "" && placeholderText !== "Tutti i Conti") { // Make placeholder unselectable unless it's "All Accounts"
                       selectEl.options[0].disabled = true;
                    }
                    options.forEach(opt => selectEl.add(opt.cloneNode(true)));
                    // Restore previous value if valid
                    if (options.some(opt => opt.value === currentVal) && currentVal !== defaultVal) {
                        selectEl.value = currentVal;
                    } else {
                        selectEl.value = defaultVal;
                    }
                };

                populateAccountSelect(elements.filterAccountSelect, accountOptions, "", "Tutti i Conti");
                populateAccountSelect(elements.transactionAccountSelect, accountOptions, "", "-- Seleziona Conto --");
                transferSelects.forEach(sel => populateAccountSelect(sel, accountOptions, "", "-- Seleziona Conto --"));


                // Populate Category Selects with Hierarchy
                const populateCategorySelect = (selectEl, includeMainOption = true, includeTransfers = false) => {
                    if (!selectEl) return;
                    const currentVal = selectEl.value; // Save current value
                    selectEl.innerHTML = ''; // Clear existing options

                    if (includeMainOption) {
                        selectEl.add(new Option("Tutte le Categorie", "", true, true));
                    } else {
                        selectEl.add(new Option("-- Seleziona Categoria --", "", true, true));
                        selectEl.options[0].disabled = true;
                    }

                    const mainCategories = categories.filter(cat => !cat.parentId && (includeTransfers || (cat.id !== TRANSFER_IN_CATEGORY_ID && cat.id !== TRANSFER_OUT_CATEGORY_ID))).sort((a, b) => a.name.localeCompare(b.name));

                    mainCategories.forEach(mainCat => {
                        const subCategories = categories.filter(cat => cat.parentId === mainCat.id).sort((a, b) => a.name.localeCompare(b.name));

                        if (subCategories.length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = mainCat.name;
                             // Add main category as a selectable option in filters
                             if (includeMainOption) {
                                optgroup.appendChild(new Option(`${mainCat.name} (Tutte)`, mainCat.id));
                             }
                            subCategories.forEach(subCat => {
                                optgroup.appendChild(new Option(subCat.name, subCat.id));
                            });
                            selectEl.appendChild(optgroup);
                        } else {
                            // Main category without subcategories, add as a direct option
                            selectEl.add(new Option(mainCat.name, mainCat.id));
                        }
                    });

                     // Restore previous value if still valid
                    if (selectEl.querySelector(`option[value="${currentVal}"]`)) {
                        selectEl.value = currentVal;
                    } else if (includeMainOption) {
                        selectEl.value = ""; // Default to "All" for filter
                    } else {
                         selectEl.value = ""; // Default to placeholder for transaction form
                    }
                    selectEl.required = !includeMainOption && categories.length > 0; // Required only for transaction form if categories exist
                };

                populateCategorySelect(elements.filterCategorySelect, true, true); // Include "All", include transfers
                populateCategorySelect(elements.transactionCategorySelect, false, false); // No "All", no transfers

                toggleNoCategoriesWarning();
             }

             /** Shows/hides warning in transaction modal. */
             function toggleNoCategoriesWarning() {
                 if (elements.noCategoriesWarning && elements.saveTransactionButton) {
                    // Check if there are any *selectable* categories (excluding transfers)
                     const hasSelectableCategories = categories.some(cat => cat.id !== TRANSFER_IN_CATEGORY_ID && cat.id !== TRANSFER_OUT_CATEGORY_ID);
                     elements.noCategoriesWarning.style.display = hasSelectableCategories ? 'none' : 'block';
                     elements.saveTransactionButton.disabled = !hasSelectableCategories;
                     if (elements.transactionCategorySelect) elements.transactionCategorySelect.required = hasSelectableCategories;
                 }
             }
        // --- End PART 1 ---

        // --- Start PART 2 ---

            /** Renders the category filter buttons under the charts. */
            function renderCategoryFilters() {
                if (!elements.incomeCategoryFilters || !elements.expenseCategoryFilters || !elements.categoryFiltersContainer) return;

                // Filters operate on MAIN categories now
                 const allMainIncomeCategories = [...new Set(transactions
                    .filter(t => t.amount > 0 && t.categoryId !== TRANSFER_IN_CATEGORY_ID && t.categoryId !== TRANSFER_OUT_CATEGORY_ID)
                    .map(t => getMainCategory(t.categoryId)?.name) // Get main category name
                    .filter(Boolean) // Remove nulls if category somehow deleted
                 )].sort();

                 const allMainExpenseCategories = [...new Set(transactions
                    .filter(t => t.amount < 0 && t.categoryId !== TRANSFER_IN_CATEGORY_ID && t.categoryId !== TRANSFER_OUT_CATEGORY_ID)
                    .map(t => getMainCategory(t.categoryId)?.name) // Get main category name
                    .filter(Boolean)
                 )].sort();


                // Function to create a single button
                const createFilterButton = (type, categoryName, isActive) => {
                    const button = document.createElement('button');
                    button.classList.add('filter-button');
                    button.dataset.type = type;
                     // Store MAIN category name in the dataset
                    button.dataset.category = categoryName; // "all" or main category name
                    button.textContent = categoryName === 'all' ? 'Tutte' : categoryName;
                    if (categoryName === 'all') {
                        button.classList.add('all-button');
                    }
                    if (isActive) {
                        button.classList.add('active');
                    }
                    return button;
                };

                // Clear existing buttons
                elements.incomeCategoryFilters.innerHTML = '';
                elements.expenseCategoryFilters.innerHTML = '';

                // Add Income buttons (filtering MAIN categories)
                const isAllIncomeActive = selectedIncomeCategories.length === 0;
                elements.incomeCategoryFilters.appendChild(createFilterButton('income', 'all', isAllIncomeActive));
                allMainIncomeCategories.forEach(mainCatName => {
                    elements.incomeCategoryFilters.appendChild(createFilterButton('income', mainCatName, selectedIncomeCategories.includes(mainCatName)));
                });

                // Add Expense buttons (filtering MAIN categories)
                const isAllExpenseActive = selectedExpenseCategories.length === 0;
                elements.expenseCategoryFilters.appendChild(createFilterButton('expense', 'all', isAllExpenseActive));
                allMainExpenseCategories.forEach(mainCatName => {
                    elements.expenseCategoryFilters.appendChild(createFilterButton('expense', mainCatName, selectedExpenseCategories.includes(mainCatName)));
                });


                // Show container only if there are categories to filter
                const hasAnyFilterableCategories = allMainIncomeCategories.length > 0 || allMainExpenseCategories.length > 0;
                elements.categoryFiltersContainer.style.display = hasAnyFilterableCategories ? 'block' : 'none';
                console.log("Category filters rendered. Visible:", hasAnyFilterableCategories, "Income selected:", selectedIncomeCategories, "Expense selected:", selectedExpenseCategories);
            }


            /** Updates total income/expense display based on filters. */
            function updateChartTotals() {
                if (!elements.totalIncomeDisplay || !elements.totalExpenseDisplay) return;

                 // Filters apply to MAIN categories selected in the arrays
                 console.log(`Updating totals. Main Income filter: [${selectedIncomeCategories.join(', ')}], Main Expense filter: [${selectedExpenseCategories.join(', ')}]`);

                 const totals = transactions.reduce((acc, t) => {
                    const amount = parseFloat(t.amount) || 0;
                    const mainCategory = getMainCategory(t.categoryId); // Get main category object
                    const mainCategoryName = mainCategory?.name; // Get its name

                    // Exclude transfers from these totals
                    if (t.categoryId === TRANSFER_IN_CATEGORY_ID || t.categoryId === TRANSFER_OUT_CATEGORY_ID) {
                        return acc;
                    }

                    // Check income filter: show if 'all' (array empty) OR main category name is in the array
                    if (amount > 0 && mainCategoryName) {
                        if (selectedIncomeCategories.length === 0 || selectedIncomeCategories.includes(mainCategoryName)) {
                            acc.income += amount;
                        }
                    }
                    // Check expense filter: show if 'all' (array empty) OR main category name is in the array
                    else if (amount < 0 && mainCategoryName) {
                        if (selectedExpenseCategories.length === 0 || selectedExpenseCategories.includes(mainCategoryName)) {
                            acc.expense += Math.abs(amount);
                        }
                    }
                    return acc;
                }, { income: 0, expense: 0 });

                elements.totalIncomeDisplay.textContent = formatCurrency(totals.income);
                elements.totalExpenseDisplay.textContent = formatCurrency(totals.expense);
            }


            /** Updates doughnut charts based on filters (aggregating by MAIN category). */
            function updateCharts() {
                if (!elements.incomeCategoryChartCanvas || !elements.expenseCategoryChartCanvas || !elements.appContent || elements.appContent.style.display === 'none') return;
                 // Ensure Chart.js is loaded before attempting to use it
                if (typeof Chart === 'undefined') {
                    console.error("Chart.js non √® ancora stato caricato. Riprovo tra poco...");
                    setTimeout(updateCharts, 200); // Retry after a short delay
                    return;
                }

                console.log(`Updating CHARTS. Main Income filter: [${selectedIncomeCategories.join(', ')}], Main Expense filter: [${selectedExpenseCategories.join(', ')}]`);

                const currentTheme = getStoredData('theme', 'light');
                const isDarkMode = currentTheme === 'dark';
                const textColor = isDarkMode ? '#e0e0e0' : '#424242';
                const chartBgColor = isDarkMode ? '#1e1e1e' : '#ffffff';
                const incomeColors = ['#388e3c', '#689f38', '#4caf50', '#8bc34a', '#cddc39', '#a5d6a7', '#7cb342'];
                const expenseColors = ['#d32f2f', '#c2185b', '#f57c00', '#e64a19', '#ff7043', '#e57373', '#f06292'];

                // Filter transactions based on selected MAIN category names arrays
                 const filteredIncomeTransactions = transactions.filter(t => {
                    if (t.amount <= 0 || t.categoryId === TRANSFER_IN_CATEGORY_ID || t.categoryId === TRANSFER_OUT_CATEGORY_ID) return false;
                    const mainCategoryName = getMainCategory(t.categoryId)?.name;
                    return selectedIncomeCategories.length === 0 || (mainCategoryName && selectedIncomeCategories.includes(mainCategoryName));
                });

                const filteredExpenseTransactions = transactions.filter(t => {
                     if (t.amount >= 0 || t.categoryId === TRANSFER_IN_CATEGORY_ID || t.categoryId === TRANSFER_OUT_CATEGORY_ID) return false;
                     const mainCategoryName = getMainCategory(t.categoryId)?.name;
                     return selectedExpenseCategories.length === 0 || (mainCategoryName && selectedExpenseCategories.includes(mainCategoryName));
                });


                 // Aggregate totals by MAIN category name
                 const incomeTotals = filteredIncomeTransactions.reduce((acc, t) => {
                    const mainCategoryName = getMainCategory(t.categoryId)?.name || 'Non Categorizzato';
                    acc[mainCategoryName] = (acc[mainCategoryName] || 0) + t.amount;
                    return acc;
                 }, {});
                const expenseTotals = filteredExpenseTransactions.reduce((acc, t) => {
                    const mainCategoryName = getMainCategory(t.categoryId)?.name || 'Non Categorizzato';
                    acc[mainCategoryName] = (acc[mainCategoryName] || 0) + Math.abs(t.amount);
                    return acc;
                }, {});

                // Determine chart titles and empty labels based on filters
                const incomeTitle = selectedIncomeCategories.length === 0 ? 'Entrate per Categoria Principale' : 'Entrate (Cat. Selezionate)';
                const expenseTitle = selectedExpenseCategories.length === 0 ? 'Spese per Categoria Principale' : 'Spese (Cat. Selezionate)';
                const incomeEmptyLabel = selectedIncomeCategories.length === 0 ? 'Nessuna Entrata' : 'Nessuna Entrata nelle Cat. Selezionate';
                const expenseEmptyLabel = selectedExpenseCategories.length === 0 ? 'Nessuna Spesa' : 'Nessuna Spesa nelle Cat. Selezionate';


                // Create Chart function (remains mostly the same, takes aggregated data)
                const createDoughnutChart = (canvasElement, dataTotals, palette, titleText, emptyLabel) => {
                     const labels = Object.keys(dataTotals).sort((a, b) => dataTotals[b] - dataTotals[a]);
                     const data = labels.map(label => dataTotals[label]);
                     const colors = labels.map((_, i) => palette[i % palette.length]);

                     const config = {
                        type: 'doughnut',
                        data: {
                            labels: labels.length ? labels : [emptyLabel],
                            datasets: [{
                                data: data.length ? data : [1], // Add dummy data if empty
                                backgroundColor: labels.length ? colors : ['#cccccc'], // Use grey if empty
                                borderColor: chartBgColor,
                                borderWidth: 2,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: titleText, color: textColor, font: { size: 16, weight: 'bold' }, padding: { bottom: 15 } },
                                legend: { position: 'bottom', labels: { color: textColor, boxWidth: 15, padding: 10 }, display: labels.length > 0 },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            let lbl = ctx.label || '';
                                            if (ctx.dataset.data.length === 1 && lbl === emptyLabel) return ` ${emptyLabel.toLowerCase()}`;
                                            if (lbl && lbl !== emptyLabel) lbl += ': ';
                                            else if (lbl === emptyLabel) return ` ${emptyLabel.toLowerCase()}`;
                                            if (ctx.parsed !== null) lbl += formatCurrency(ctx.parsed);
                                            const total = ctx.dataset.data.reduce((s, v) => s + v, 0);
                                            if (total > 0 && labels.length > 0 && ctx.parsed) {
                                                const perc = ((ctx.parsed / total) * 100).toFixed(1) + '%';
                                                lbl += ` (${perc})`;
                                            }
                                            return lbl;
                                        }
                                    }
                                }
                            },
                            animation: { animateScale: true, animateRotate: true }
                        }
                    };
                    try {
                        const ctx = canvasElement.getContext('2d');
                        if (!ctx) throw new Error("No context");
                        return new Chart(ctx, config);
                    } catch (e) {
                        console.error(`Chart Error "${titleText}":`, e);
                        displayAppError(`Errore grafico: ${titleText}.`);
                        return null;
                    }
                };

                // Destroy old charts safely
                if (incomeCategoryChart && typeof incomeCategoryChart.destroy === 'function') {
                    try { incomeCategoryChart.destroy(); } catch (e) { console.warn("Error destroying income chart:", e); }
                    incomeCategoryChart = null;
                }
                if (expenseCategoryChart && typeof expenseCategoryChart.destroy === 'function') {
                    try { expenseCategoryChart.destroy(); } catch (e) { console.warn("Error destroying expense chart:", e); }
                    expenseCategoryChart = null;
                }


                // Create new charts
                incomeCategoryChart = createDoughnutChart(elements.incomeCategoryChartCanvas, incomeTotals, incomeColors, incomeTitle, incomeEmptyLabel);
                expenseCategoryChart = createDoughnutChart(elements.expenseCategoryChartCanvas, expenseTotals, expenseColors, expenseTitle, expenseEmptyLabel);
            }


            /** Updates chart colors on theme change. */
            function updateChartColors() {
                const currentTheme = getStoredData('theme', 'light'); const isDarkMode = currentTheme === 'dark'; const textColor = isDarkMode ? '#e0e0e0' : '#424242'; const chartBgColor = isDarkMode ? '#1e1e1e' : '#ffffff'; const applyUpdates = (chart) => { if (!chart || !chart.options) return; if(chart.options.plugins?.title) chart.options.plugins.title.color = textColor; if(chart.options.plugins?.legend?.labels) chart.options.plugins.legend.labels.color = textColor; if(chart.data.datasets?.[0]) chart.data.datasets[0].borderColor = chartBgColor; const isActive = chart.ctx && (chart.attached || chart.rendered); if (isActive && chart.canvas && chart.canvas.offsetParent !== null) { try { chart.update('none'); } catch (e) { console.warn("Minor error updating chart colors:", e); } } }; setTimeout(() => { if (incomeCategoryChart) applyUpdates(incomeCategoryChart); if (expenseCategoryChart) applyUpdates(expenseCategoryChart); }, 50);
            }

            /** Central UI refresh function. */
             function updateUI(options = {}) {
                 const {
                     updateAccounts = true, updateTransactions = true, updateGoals = true,
                     updateCategories = false, updateSelects = true,
                     shouldUpdateCharts = true, shouldUpdateFilters = true, shouldUpdateTotals = true
                 } = options;
                 console.log("Updating UI with options:", options);

                 if (updateAccounts) loadAccounts();
                 if (updateGoals) loadSavingsGoals();
                 if (updateCategories) loadCategoriesForSettings(); // Refresh settings modal list
                 if (updateSelects) updateSelectOptions(); // Refresh dropdowns (now hierarchical)
                 if (updateTransactions) loadTransactions(); // Refresh transaction list (uses own filters)

                 // Refresh chart-related elements using the multi-select state
                 if (shouldUpdateFilters) renderCategoryFilters();
                 if (shouldUpdateTotals) updateChartTotals();
                 if (shouldUpdateCharts) updateCharts();

                 console.log("UI Update complete.");
             }

            // --- CRUD Event Handlers ---
            /** Sets up common list event listeners (Edit/Delete/Add Sub). */
            function setupListEventListeners(listElement, dataType, callbacks) {
                if (!listElement) { console.warn(`List element for ${dataType} not found.`); return; }
                const listenerKey = `${dataType}ListListener`;
                if (listElement[listenerKey]) { listElement.removeEventListener('click', listElement[listenerKey]); }

                const handler = (event) => {
                    const editButton = event.target.closest('.edit-button[data-id]:not([disabled])');
                    const deleteButton = event.target.closest('.delete-button[data-id]:not([disabled])');
                    const addSubButton = event.target.closest('.add-subcategory-button[data-parent-id]'); // New listener for subcategory

                    if (editButton && callbacks.onEdit) {
                        const id = editButton.dataset.id;
                        console.log(`Action: Edit on ${dataType} ID: ${id}`);
                        callbacks.onEdit(id);
                    } else if (deleteButton && callbacks.onDelete) {
                         const id = deleteButton.dataset.id;
                         console.log(`Action: Delete on ${dataType} ID: ${id}`);
                         callbacks.onDelete(id);
                    } else if (addSubButton && callbacks.onAddSub) {
                         const parentId = addSubButton.dataset.parentId;
                         console.log(`Action: Add Subcategory to Parent ID: ${parentId}`);
                         callbacks.onAddSub(parentId);
                    }
                };
                listElement.addEventListener('click', handler);
                listElement[listenerKey] = handler;
            }
        // --- End PART 2 ---

        // --- Start PART 3 ---

            // Account CRUD
            if (elements.addAccountBtn) elements.addAccountBtn.addEventListener('click', () => openModal('account-modal', false, elements.accountModalTitle));
            if (elements.accountForm) { elements.accountForm.addEventListener('submit', function(event) {
                event.preventDefault(); if (!validateForm(this, {'account-name':'required', 'account-initial-balance':'required|number'})) return; const idInput = this.querySelector('#account-id'); const editingId = idInput.value; const name = this.querySelector('#account-name').value.trim(); const initialBalance = parseFloat(this.querySelector('#account-initial-balance').value.replace(',', '.')) || 0; const color = this.querySelector('#account-color').value; console.log(`Submitting account form. Editing ID from hidden input: "${editingId}"`); if (accounts.some(a => a.name.toLowerCase() === name.toLowerCase() && a.id !== editingId)) { showFieldMessage('account-name', 'Nome conto gi√† esistente.'); this.querySelector('#account-name').focus(); return; } let updatedAccounts; const accountData = { name, initialBalance, color }; if (editingId) { console.log(">>> Mode: EDIT Account", editingId); accountData.id = editingId; updatedAccounts = accounts.map(a => (a.id === editingId ? accountData : a)); } else { console.log(">>> Mode: ADD Account"); accountData.id = `acc_${Date.now()}`; updatedAccounts = [...accounts, accountData]; } storeData('accounts', updatedAccounts); updateUI({ updateAccounts: true, updateTransactions: true, updateSelects: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true }); closeModal(elements.accountModal);
             }); }
            setupListEventListeners(elements.accountsList, 'account', { onEdit: (id) => {
                const acc = accounts.find(a => a.id === id); if (acc && elements.accountForm) { console.log("Populating account form for edit, ID:", id, acc); elements.accountForm.querySelector('#account-id').value = acc.id; elements.accountForm.querySelector('#account-name').value = acc.name; elements.accountForm.querySelector('#account-initial-balance').value = (parseFloat(acc.initialBalance) || 0).toFixed(2); elements.accountForm.querySelector('#account-color').value = acc.color || '#cccccc'; openModal('account-modal', true, elements.accountModalTitle, 'Modifica Conto'); } else { displayAppError(`Conto ID "${id}" non trovato.`); }
             }, onDelete: (id) => {
                 // Check if account is used in transfers before deleting
                 const isUsedInTransfer = transactions.some(t =>
                    (t.categoryId === TRANSFER_OUT_CATEGORY_ID || t.categoryId === TRANSFER_IN_CATEGORY_ID) &&
                    (t.account === id || transactions.find(t2 => t2.transferId === t.transferId && t2.id !== t.id)?.account === id)
                 );
                 const hasRegularTx = transactions.some(t => t.account === id && t.categoryId !== TRANSFER_IN_CATEGORY_ID && t.categoryId !== TRANSFER_OUT_CATEGORY_ID);

                 const acc = accounts.find(a => a.id === id);
                 if (!acc) { displayAppError(`Conto ID "${id}" non trovato.`); return; }
                 if (accounts.length <= 1 && isUsedInTransfer) { // Cannot delete last account if used in transfers
                     alert("Impossibile eliminare l'unico conto se √® stato usato in giroconti.");
                     return;
                 }

                 const name = acc.name || 'questo conto';
                 let msg = `Eliminare il conto "${name}"?`;
                 if (hasRegularTx) msg += "\nATTENZIONE: Contiene transazioni regolari che rimarranno senza conto (Conto Sconosciuto).";
                 if (isUsedInTransfer) msg += "\nATTENZIONE: Contiene giroconti che potrebbero diventare inconsistenti.";
                 if (confirm(msg)) {
                    storeData('accounts', accounts.filter(a => a.id !== id));
                    // Consider handling orphaned transfers if needed, for now just update UI
                    updateUI({ updateAccounts: true, updateTransactions: true, updateSelects: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true });
                }
             } });

            // Transaction CRUD
            if (elements.addTransactionBtn) elements.addTransactionBtn.addEventListener('click', () => openModal('transaction-modal', false, elements.transactionModalTitle));
            if (elements.transactionForm) { elements.transactionForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const selectableCats = categories.filter(c => c.id !== TRANSFER_IN_CATEGORY_ID && c.id !== TRANSFER_OUT_CATEGORY_ID);
                if (selectableCats.length === 0) { showFieldMessage('transaction-category', 'Aggiungere una categoria (non di giroconto) prima.'); return; }
                const rules = { 'transaction-date': 'required', 'transaction-amount': 'required|number', 'transaction-category': 'required', 'transaction-account': 'required' };
                if (!validateForm(this, rules)) return;

                const idInput = this.querySelector('#transaction-id');
                const editingId = idInput.value;
                const date = this.querySelector('#transaction-date').value;
                const amount = parseFloat(this.querySelector('#transaction-amount').value.replace(',', '.')) || 0;
                const categoryId = this.querySelector('#transaction-category').value; // This is now the ID
                const accountId = this.querySelector('#transaction-account').value;
                const description = this.querySelector('#transaction-description').value.trim();

                if (isNaN(new Date(date))) { showFieldMessage('transaction-date', 'Data non valida.'); return; }
                if (!accounts.some(a => a.id === accountId)) { showFieldMessage('transaction-account', 'Conto non valido.'); return; }
                const selectedCat = findCategoryById(categoryId);
                if (!selectedCat || selectedCat.id === TRANSFER_IN_CATEGORY_ID || selectedCat.id === TRANSFER_OUT_CATEGORY_ID) { // Prevent selecting transfer categories here
                     showFieldMessage('transaction-category', 'Categoria selezionata non valida.'); return;
                 }
                // Optional: Prevent selecting main categories that have subcategories?
                // const hasSubcategories = categories.some(c => c.parentId === categoryId);
                // if (hasSubcategories) {
                //     showFieldMessage('transaction-category', 'Selezionare una sottocategoria specifica.'); return;
                // }

                let updatedTransactions;
                const txData = { date, description, amount, categoryId, account: accountId, transferId: null }; // Ensure transferId is null for regular tx

                if (editingId) {
                    console.log(">>> Mode: EDIT Transaction", editingId);
                    txData.id = editingId;
                    // Find original transaction to preserve transferId if it was a transfer being edited (shouldn't happen with current UI)
                    const originalTx = transactions.find(t => t.id === editingId);
                    txData.transferId = originalTx?.transferId || null; // Keep transferId if it existed
                    updatedTransactions = transactions.map(t => (t.id === editingId ? txData : t));
                } else {
                    console.log(">>> Mode: ADD Transaction");
                    txData.id = `txn_${Date.now()}`;
                    updatedTransactions = [...transactions, txData];
                }
                storeData('transactions', updatedTransactions);
                updateUI({ updateAccounts: true, updateTransactions: true, updateSelects: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true });
                closeModal(elements.transactionModal);
             }); }
            setupListEventListeners(elements.transactionsList, 'transaction', { onEdit: (id) => {
                const tx = transactions.find(t => t.id === id);
                 // Prevent editing of transfer transactions directly for simplicity
                 if (tx && (tx.categoryId === TRANSFER_IN_CATEGORY_ID || tx.categoryId === TRANSFER_OUT_CATEGORY_ID)) {
                     alert("I giroconti possono essere solo eliminati, non modificati.");
                     return;
                 }
                 if (tx && elements.transactionForm) {
                     console.log("Populating transaction form for edit, ID:", id, tx);
                     elements.transactionForm.querySelector('#transaction-id').value = tx.id;
                     elements.transactionForm.querySelector('#transaction-date').value = tx.date;
                     elements.transactionForm.querySelector('#transaction-description').value = tx.description || '';
                     elements.transactionForm.querySelector('#transaction-amount').value = (parseFloat(tx.amount) || 0).toFixed(2);
                     updateSelectOptions(); // Refresh selects first
                     setTimeout(() => { // Delay setting values as options might repopulate
                         if (elements.transactionForm.querySelector('#transaction-category')) elements.transactionForm.querySelector('#transaction-category').value = tx.categoryId; // Use ID
                         if (elements.transactionForm.querySelector('#transaction-account')) elements.transactionForm.querySelector('#transaction-account').value = tx.account;
                     }, 50);
                     openModal('transaction-modal', true, elements.transactionModalTitle, 'Modifica Transazione');
                 } else { displayAppError(`Transazione ID "${id}" non trovata o non modificabile.`); }
             }, onDelete: (id) => {
                 const txToDelete = transactions.find(t => t.id === id);
                 if (!txToDelete) { displayAppError(`Transazione ID "${id}" non trovata.`); return; }

                 let confirmMsg = 'Eliminare questa transazione?';
                 let isTransfer = txToDelete.categoryId === TRANSFER_OUT_CATEGORY_ID || txToDelete.categoryId === TRANSFER_IN_CATEGORY_ID;
                 let transferIdToDelete = isTransfer ? txToDelete.transferId : null;

                 if (isTransfer) {
                     confirmMsg = 'Eliminare questo giroconto? Verranno eliminate entrambe le transazioni collegate (entrata e uscita).';
                 }

                 if (confirm(confirmMsg)) {
                     let updatedTransactions;
                     if (isTransfer && transferIdToDelete) {
                         // Delete both sides of the transfer
                         updatedTransactions = transactions.filter(t => t.transferId !== transferIdToDelete);
                         console.log(`Deleted transfer pair with transferId: ${transferIdToDelete}`);
                     } else {
                         // Delete single regular transaction
                         updatedTransactions = transactions.filter(t => t.id !== id);
                         console.log(`Deleted transaction ID: ${id}`);
                     }
                     storeData('transactions', updatedTransactions);
                     updateUI({ updateAccounts: true, updateTransactions: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true });
                 }
             } });


            // --- NEW: Giroconto (Transfer) Logic ---
             if (elements.addTransferBtn) {
                 elements.addTransferBtn.addEventListener('click', () => {
                     if (accounts.length < 2) {
                         alert("Devi avere almeno due conti per effettuare un giroconto.");
                         return;
                     }
                     // Pass null context data as we are not editing
                     openModal('transfer-modal', false, null, null, null);
                 });
             }
             if (elements.transferForm) {
                 elements.transferForm.addEventListener('submit', function(event) {
                     event.preventDefault();
                     const rules = {
                         'transfer-date': 'required',
                         'transfer-amount': 'required|positive|min:0.01', // Amount must be positive
                         'transfer-from-account': 'required',
                         'transfer-to-account': 'required|differentFrom:#transfer-from-account' // Ensure different accounts
                     };
                     if (!validateForm(this, rules)) return;

                     const date = this.querySelector('#transfer-date').value;
                     const amount = parseFloat(this.querySelector('#transfer-amount').value.replace(',', '.')) || 0;
                     const fromAccountId = this.querySelector('#transfer-from-account').value;
                     const toAccountId = this.querySelector('#transfer-to-account').value;
                     const description = this.querySelector('#transfer-description').value.trim();

                     if (isNaN(new Date(date))) { showFieldMessage('transfer-date', 'Data non valida.'); return; }
                     if (amount <= 0) { showFieldMessage('transfer-amount', 'L\'importo deve essere positivo.'); return; } // Should be caught by validation, but double-check
                     if (fromAccountId === toAccountId) { showFieldMessage('transfer-to-account', 'Il conto di destinazione deve essere diverso da quello di origine.'); return; } // Should be caught by validation

                     const fromAccount = accounts.find(a => a.id === fromAccountId);
                     const toAccount = accounts.find(a => a.id === toAccountId);
                     if (!fromAccount || !toAccount) { displayAppError("Conti selezionati per il giroconto non validi."); return; }

                     const transferId = `trf_${Date.now()}`; // Unique ID for this transfer pair
                     const commonDescription = description || `Giroconto da ${fromAccount.name} a ${toAccount.name}`;

                     // Create two transactions
                     const transactionOut = {
                         id: `txn_${transferId}_out`,
                         date: date,
                         amount: -amount, // Negative amount for outgoing
                         categoryId: TRANSFER_OUT_CATEGORY_ID, // Special category ID
                         account: fromAccountId,
                         description: commonDescription,
                         transferId: transferId // Link to the pair
                     };
                     const transactionIn = {
                         id: `txn_${transferId}_in`,
                         date: date,
                         amount: amount, // Positive amount for incoming
                         categoryId: TRANSFER_IN_CATEGORY_ID, // Special category ID
                         account: toAccountId,
                         description: commonDescription,
                         transferId: transferId // Link to the pair
                     };

                     const updatedTransactions = [...transactions, transactionOut, transactionIn];
                     storeData('transactions', updatedTransactions);
                     updateUI({ updateAccounts: true, updateTransactions: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true });
                     closeModal(elements.transferModal);
                 });
             }


            // Category CRUD (Updated for Hierarchy)
            if (elements.addMainCategoryBtn) elements.addMainCategoryBtn.addEventListener('click', () => {
                // Open category modal for adding a MAIN category (no parentId)
                openModal('category-modal', false, elements.categoryModalTitle, null, { parentId: null });
            });

            if (elements.categoryForm) { elements.categoryForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (!validateForm(this, {'category-name':'required'})) return;

                const idInput = this.querySelector('#category-id');
                const parentIdInput = this.querySelector('#category-parent-id');
                const nameInput = this.querySelector('#category-name');
                const name = nameInput.value.trim();
                const editingId = idInput.value;
                const parentId = parentIdInput.value || null; // Get parentId, default to null

                // Check for duplicate names within the same level (same parent)
                 const siblings = categories.filter(c => c.parentId === parentId && c.id !== editingId);
                 if (siblings.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                     const level = parentId ? 'sottocategoria con questo nome esiste gi√† per questa categoria principale' : 'categoria principale con questo nome esiste gi√†';
                     showFieldMessage('category-name', `Una ${level}.`);
                     nameInput.focus();
                     return;
                 }

                let updatedCategories;
                let transactionsNeedUpdate = false;
                let oldName = null;
                const categoryData = { name, parentId };

                if (editingId) { // Editing existing category/subcategory
                    console.log(`>>> Mode: EDIT Category ID: ${editingId}, Parent: ${parentId}`);
                    const original = findCategoryById(editingId);
                    if (original && original.name !== name) {
                        oldName = original.name;
                         // If it's a MAIN category being renamed, update filters
                         if (!original.parentId) {
                             selectedIncomeCategories = selectedIncomeCategories.map(catName => catName === oldName ? name : catName);
                             selectedExpenseCategories = selectedExpenseCategories.map(catName => catName === oldName ? name : catName);
                         }
                         // Note: Renaming categories won't automatically update transaction category paths shown in the list (getCategoryPathName uses current names)
                         // This could be complex to handle perfectly without a full re-render or more complex state management.
                        console.log(`Category name change: "${oldName}" -> "${name}". Filter update might be needed.`);
                    }
                    categoryData.id = editingId;
                    updatedCategories = categories.map(c => (c.id === editingId ? categoryData : c));
                } else { // Adding new category/subcategory
                    categoryData.id = `cat_${Date.now()}`;
                    console.log(`>>> Mode: ADD Category ID: ${categoryData.id}, Parent: ${parentId}`);
                    updatedCategories = [...categories, categoryData];
                }

                storeData('categories', updatedCategories);
                 // Full UI update is safest after category changes due to hierarchy dependencies
                updateUI({ updateCategories: true, updateSelects: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true, updateTransactions: true });
                closeModal(elements.categoryModal);
             }); }

            /** Determines if a category can be deleted. */
             function canDeleteCategory(categoryId) {
                 if (!categoryId || categoryId === TRANSFER_IN_CATEGORY_ID || categoryId === TRANSFER_OUT_CATEGORY_ID) {
                     return { allowed: false, reason: "Categoria speciale non eliminabile." };
                 }
                 // Check if it has subcategories
                 const hasSubcategories = categories.some(cat => cat.parentId === categoryId);
                 if (hasSubcategories) {
                     return { allowed: false, reason: "Eliminare prima le sottocategorie." };
                 }
                 // Check if used in transactions
                 const isUsed = transactions.some(tx => tx.categoryId === categoryId);
                 if (isUsed) {
                     return { allowed: false, reason: "Categoria utilizzata in transazioni." };
                 }
                 return { allowed: true };
             }

            setupListEventListeners(elements.categoriesListModal, 'category', {
                onEdit: (id) => {
                     if (id === TRANSFER_IN_CATEGORY_ID || id === TRANSFER_OUT_CATEGORY_ID) {
                        alert("Le categorie Giroconto non sono modificabili.");
                        return;
                     }
                     const cat = findCategoryById(id);
                     if (cat && elements.categoryForm) {
                        console.log("Populating category form for edit, ID:", id, cat);
                        elements.categoryForm.querySelector('#category-id').value = cat.id;
                        elements.categoryForm.querySelector('#category-name').value = cat.name;
                        elements.categoryForm.querySelector('#category-parent-id').value = cat.parentId || ''; // Set parent ID
                        const title = cat.parentId ? 'Modifica Sottocategoria' : 'Modifica Categoria Principale';
                        // Pass parent context only needed if ADDING subcategory, not editing
                        openModal('category-modal', true, elements.categoryModalTitle, title, null);
                    } else { displayAppError(`Categoria ID "${id}" non trovata.`); }
                },
                onDelete: (id) => {
                    const cat = findCategoryById(id);
                    if (!cat) { displayAppError(`Categoria ID "${id}" non trovata.`); return; }

                    const check = canDeleteCategory(id);
                    if (!check.allowed) {
                        alert(`Impossibile eliminare "${cat.name}": ${check.reason}`);
                        return;
                    }

                    if (confirm(`Eliminare la categoria "${cat.name}"?`)) {
                         // If it's a MAIN category being deleted, remove from filters
                         if (!cat.parentId) {
                            selectedIncomeCategories = selectedIncomeCategories.filter(catName => catName !== cat.name);
                            selectedExpenseCategories = selectedExpenseCategories.filter(catName => catName !== cat.name);
                        }
                        storeData('categories', categories.filter(c => c.id !== id));
                        updateUI({ updateCategories: true, updateSelects: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true, updateTransactions: true });
                    }
                },
                onAddSub: (parentId) => { // Handle Add Subcategory button click
                    const parentCat = findCategoryById(parentId);
                    if (parentCat) {
                         // Open category modal in "add" mode, passing the parentId
                         openModal('category-modal', false, elements.categoryModalTitle, null, { parentId: parentId });
                     } else {
                        displayAppError(`Categoria genitore ID "${parentId}" non trovata.`);
                     }
                }
            });


            // Savings Goal CRUD (No changes needed for subcategories)
            if (elements.addGoalBtn) elements.addGoalBtn.addEventListener('click', () => openModal('goal-modal', false, elements.goalModalTitle));
            if (elements.goalForm) { elements.goalForm.addEventListener('submit', function(event) {
                event.preventDefault(); if (!validateForm(this, {'goal-name':'required', 'goal-target-amount':'required|positive|min:0.01'})) return; const idInput = this.querySelector('#goal-id'); const editingId = idInput.value; const name = this.querySelector('#goal-name').value.trim(); const target = parseFloat(this.querySelector('#goal-target-amount').value.replace(',', '.')) || 0; if (savingsGoals.some(g => g.name.toLowerCase() === name.toLowerCase() && g.id !== editingId)) { showFieldMessage('goal-name', 'Nome obiettivo gi√† esistente.'); this.querySelector('#goal-name').focus(); return; } if (target <= 0) { showFieldMessage('goal-target-amount', 'Importo deve essere > 0.'); return; } let updatedGoals; const goalData = { name, targetAmount: target }; if (editingId) { console.log(">>> Mode: EDIT Goal", editingId); goalData.id = editingId; updatedGoals = savingsGoals.map(g => (g.id === editingId ? goalData : g)); } else { console.log(">>> Mode: ADD Goal"); goalData.id = `goal_${Date.now()}`; updatedGoals = [...savingsGoals, goalData]; } storeData('savingsGoals', updatedGoals); updateUI({ updateGoals: true }); closeModal(elements.goalModal);
             }); }
            setupListEventListeners(elements.savingsGoalsList, 'goal', { onEdit: (id) => {
                const goal = savingsGoals.find(g => g.id === id); if (goal && elements.goalForm) { console.log("Populating goal form for edit, ID:", id, goal); elements.goalForm.querySelector('#goal-id').value = goal.id; elements.goalForm.querySelector('#goal-name').value = goal.name; elements.goalForm.querySelector('#goal-target-amount').value = (parseFloat(goal.targetAmount) || 0).toFixed(2); openModal('goal-modal', true, elements.goalModalTitle, 'Modifica Obiettivo'); } else { displayAppError(`Obiettivo ID "${id}" non trovato.`); }
             }, onDelete: (id) => {
                const goal = savingsGoals.find(g => g.id === id); if (!goal) { displayAppError(`Obiettivo ID "${id}" non trovata.`); return; } if (confirm(`Eliminare l'obiettivo "${goal.name || 'senza nome'}"?`)) { storeData('savingsGoals', savingsGoals.filter(g => g.id !== id)); updateUI({ updateGoals: true }); }
             } });

            // --- Settings Modal Logic ---
            function setupSettingsListeners() {
                if (!elements.settingsModal || elements.settingsModal.dataset.listenersAttached === 'true') return;
                const settingsElements = {
                    changePinInput: elements.settingsModal.querySelector('#change-pin-input'),
                    changePinButton: elements.settingsModal.querySelector('#change-pin-button'),
                    pinChangeMessage: elements.settingsModal.querySelector('#pin-change-message'),
                    pinChangeError: elements.settingsModal.querySelector('#pin-change-error'),
                    // Removed addCategoryBtn reference, using addMainCategoryBtn now
                    // addCategoryBtn: elements.settingsModal.querySelector('#add-category-btn'),
                    exportJsonButton: elements.settingsModal.querySelector('#export-json-button'),
                    importJsonButton: elements.settingsModal.querySelector('#import-json-button'),
                    importJsonInput: elements.settingsModal.querySelector('#import-json-input'),
                    exportCsvButton: elements.settingsModal.querySelector('#export-csv-button'),
                    importCsvButton: elements.settingsModal.querySelector('#import-csv-button'),
                    importCsvInput: elements.settingsModal.querySelector('#import-csv-input'),
                    csvImportError: elements.settingsModal.querySelector('#csv-import-error'),
                    csvImportSuccess: elements.settingsModal.querySelector('#csv-import-success'),
                    resetDataButton: elements.settingsModal.querySelector('#reset-data-button'),
                };

                // Validate essential elements are found
                if (!settingsElements.changePinButton || !elements.addMainCategoryBtn || !settingsElements.resetDataButton || !settingsElements.exportJsonButton) {
                    console.error("Essential settings elements not found. Cannot attach listeners.");
                    return;
                }


                // Change PIN
                const handleChangePin = () => {
                    settingsElements.pinChangeError.textContent = '';
                    settingsElements.pinChangeMessage.textContent = '';
                    const pinContainer = settingsElements.changePinInput.closest('.setting-item');
                    if (!pinContainer) { console.error("PIN setting item container missing."); return; }
                    if (validateForm(pinContainer, { 'change-pin-input': 'pin' })) {
                        const newPin = settingsElements.changePinInput.value;
                        storeData('pin', newPin);
                        settingsElements.pinChangeMessage.textContent = 'PIN aggiornato!';
                        settingsElements.changePinInput.value = '';
                        setTimeout(() => { if (settingsElements.pinChangeMessage) settingsElements.pinChangeMessage.textContent = ''; }, 3000);
                    } else if (settingsElements.changePinInput) {
                        settingsElements.changePinInput.focus();
                    }
                };
                settingsElements.changePinButton.addEventListener('click', handleChangePin);
                if (settingsElements.changePinInput) settingsElements.changePinInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChangePin(); });

                // Add MAIN Category Button (already handled in Category CRUD section)

                // JSON Export
                if (settingsElements.exportJsonButton) settingsElements.exportJsonButton.addEventListener('click', () => {
                    try {
                        const allData = {
                            _appVersion: APP_VERSION, // Include version for potential future migrations
                            _exportDate: new Date().toISOString(),
                            accounts: getStoredData('accounts', []),
                            transactions: getStoredData('transactions', []), // Already uses categoryId
                            categories: getStoredData('categories', []), // Now includes parentId
                            savingsGoals: getStoredData('savingsGoals', []),
                            pin: getStoredData('pin', DEFAULT_PIN),
                            theme: getStoredData('theme', 'light'),
                            // Explicitly DO NOT export lastBackupTimestamp, user should do it manually
                        };
                        const jsonData = JSON.stringify(allData, null, 2);
                        const blob = new Blob([jsonData], { type: 'application/json;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        const ts = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, "");
                        a.download = `mattia_finanze_backup_${ts}.json`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        // ** Update last backup timestamp on successful export **
                         storeData('lastBackupTimestamp', Date.now());
                         hideBackupReminder(); // Hide reminder immediately after export

                    } catch (error) {
                        console.error("JSON Export Error:", error);
                        displayAppError("Errore esportazione JSON.");
                    }
                });

                // JSON Import
                if (settingsElements.importJsonButton && settingsElements.importJsonInput) {
                    settingsElements.importJsonButton.addEventListener('click', () => settingsElements.importJsonInput.click());
                    settingsElements.importJsonInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        if (!file) { settingsElements.importJsonInput.value = ''; return; }
                        if (!confirm("IMPORTAZIONE JSON\n\nATTENZIONE: SOSTITUIR√Ä TUTTI i dati attuali (conti, transazioni, categorie, obiettivi, PIN, tema).\n\nProcedere?")) {
                            settingsElements.importJsonInput.value = ''; return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const imp = JSON.parse(e.target.result);
                                // Basic validation - check for essential arrays
                                if (typeof imp !== 'object' || !Array.isArray(imp.accounts) || !Array.isArray(imp.transactions) || !Array.isArray(imp.categories) || !Array.isArray(imp.savingsGoals)) {
                                    throw new Error("Formato JSON non valido o dati essenziali mancanti.");
                                }

                                // Import and store data (using getStoredData structure for validation/migration logic)
                                storeData('accounts', getStoredData('accounts', imp.accounts || []));
                                // Temporarily store imported categories to use in transaction migration
                                const importedCategories = getStoredData('categories', imp.categories || []);
                                storeData('categories', importedCategories); // Store validated/migrated categories
                                // Now import transactions, which will use the just-stored categories for potential migration
                                storeData('transactions', getStoredData('transactions', imp.transactions || []));
                                storeData('savingsGoals', getStoredData('savingsGoals', imp.savingsGoals || []));

                                const impPin = imp.pin;
                                storeData('pin', (typeof impPin === 'string' && /^\d{4}$/.test(impPin)) ? impPin : DEFAULT_PIN);
                                const impTheme = imp.theme;
                                storeData('theme', (impTheme === 'light' || impTheme === 'dark') ? impTheme : 'light');

                                // Reset chart category filters after import
                                selectedIncomeCategories = [];
                                selectedExpenseCategories = [];
                                // Update last backup timestamp after successful import
                                storeData('lastBackupTimestamp', Date.now());
                                hideBackupReminder();

                                alert("Dati importati con successo! L'applicazione verr√† ricaricata.");
                                location.reload();
                            } catch (err) {
                                console.error("JSON Import Error:", err);
                                displayAppError(`Errore importazione JSON: ${err.message}. Controlla la console per dettagli.`);
                                 // Attempt to restore previous state if import fails badly? Maybe too complex.
                            } finally {
                                settingsElements.importJsonInput.value = '';
                            }
                        };
                        reader.onerror = () => {
                            displayAppError("Errore durante la lettura del file JSON.");
                            settingsElements.importJsonInput.value = '';
                        };
                        reader.readAsText(file);
                    });
                }


                // CSV Export
                if (settingsElements.exportCsvButton) settingsElements.exportCsvButton.addEventListener('click', () => {
                    try {
                        const currentTransactions = getStoredData('transactions', []);
                        const currentAccounts = getStoredData('accounts', []);
                        const currentCategories = getStoredData('categories', []); // Needed for path name

                        const nonTransferTransactions = currentTransactions.filter(
                            t => t.categoryId !== TRANSFER_IN_CATEGORY_ID && t.categoryId !== TRANSFER_OUT_CATEGORY_ID
                        );

                        if (nonTransferTransactions.length === 0) { alert("Nessuna transazione (esclusi giroconti) da esportare."); return; }

                        const headers = ["Data", "Importo", "Valuta", "Categoria Completa", "Conto", "Descrizione", "ID Transazione", "ID Categoria"];
                        const escapeCsvField = (f) => { const s = String(f ?? ''); return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s; };

                        const csvRows = nonTransferTransactions
                            .sort((a, b) => (new Date(a.date) - new Date(b.date)))
                            .map(t => {
                                const accName = currentAccounts.find(a => a.id === t.account)?.name || `ID: ${t.account||'N/D'}`;
                                const txDate = new Date(t.date);
                                const dateF = !isNaN(txDate) ? txDate.toLocaleDateString('it-IT') : 'N/D';
                                const amountF = (parseFloat(t.amount)||0).toFixed(2).replace('.', ',');
                                const categoryPath = getCategoryPathName(t.categoryId); // Get full path
                                return [dateF, amountF, 'EUR', categoryPath || '', accName, t.description || '', t.id || '', t.categoryId || ''].map(escapeCsvField);
                            });

                        const csvString = [headers.join(','), ...csvRows.map(row => row.join(','))].join('\n');
                        const BOM = "\uFEFF";
                        const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        const ts = new Date().toISOString().slice(0, 10).replace(/-/g, "");
                        a.download = `mattia_finanze_transazioni_${ts}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } catch (err) {
                        console.error("CSV Export Error:", err);
                        displayAppError("Errore durante l'esportazione CSV.");
                    }
                });

                // CSV Import (Note: Less robust than JSON, doesn't handle hierarchy well)
                if (settingsElements.importCsvButton && settingsElements.importCsvInput) {
                    settingsElements.importCsvButton.addEventListener('click', () => {
                        settingsElements.csvImportError.textContent=''; settingsElements.csvImportSuccess.textContent='';
                        settingsElements.importCsvInput.click();
                    });
                    settingsElements.importCsvInput.addEventListener('change', (event) => {
                         // Basic CSV import functionality remains, but hierarchy is ignored.
                         // It will try to match category names directly or create new *main* categories.
                        const file = event.target.files[0];
                        if (!file) { settingsElements.importCsvInput.value = ''; return; }
                        settingsElements.csvImportError.textContent=''; settingsElements.csvImportSuccess.textContent='';

                        if (!file.type.match(/^(text\/csv|application\/vnd\.ms-excel)$/) && !file.name.toLowerCase().endsWith('.csv')) {
                            settingsElements.csvImportError.textContent = 'Formato file non valido. Seleziona un file .csv.';
                            settingsElements.importCsvInput.value = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const csvText = e.target.result;
                                // Pass COPIES of state to avoid modifying global state if cancelled
                                let currentAccountsCopy = JSON.parse(JSON.stringify(accounts));
                                let currentCategoriesCopy = JSON.parse(JSON.stringify(categories));

                                const { importedTxs, createdAccId, createdCatNames, errors, accountStateChanged, categoryStateChanged } =
                                    parseCsvTransactions(csvText, currentAccountsCopy, currentCategoriesCopy); // Use copies

                                let rowErrMsg = "";
                                if (errors.length > 0) {
                                    rowErrMsg = `\n${errors.length} righe con errori sono state saltate (controlla la console per dettagli).`;
                                    errors.forEach(err => console.warn(`CSV Import Row Error (Riga ${err.line}): ${err.message}`, err.rawLine || ''));
                                }

                                if (importedTxs?.length > 0) {
                                    let confMsg = `IMPORTAZIONE CSV\n\nSono state trovate ${importedTxs.length} transazioni valide nel file.${rowErrMsg}\n`;
                                    confMsg += "NOTA: Le categorie verranno importate come categorie principali se non esiste gi√† un nome corrispondente.\n";
                                    if(accountStateChanged) confMsg += `√à stato creato/utilizzato un conto di fallback ('${currentAccountsCopy.find(a=>a.id===createdAccId)?.name || 'Conto da Import CSV'}') per le righe con conti non riconosciuti.\n`;
                                    if(categoryStateChanged) confMsg += `Sono state create ${createdCatNames.length} nuove categorie PRINCIPALI: ${createdCatNames.join(', ')}.\n`;
                                    confMsg += `\nVuoi AGGIUNGERE queste transazioni all'app? (Le transazioni con ID gi√† esistente verranno saltate)`;

                                    if (confirm(confMsg)) {
                                        // Apply state changes ONLY if confirmed
                                        if (accountStateChanged) storeData('accounts', currentAccountsCopy);
                                        if (categoryStateChanged) storeData('categories', currentCategoriesCopy);

                                        const existingTransactions = getStoredData('transactions');
                                        const existingTxIds = new Set(existingTransactions.map(tx => tx.id));
                                        const newUniqueTxs = importedTxs.filter(imp => imp.id && !existingTxIds.has(imp.id));
                                        const skippedCount = importedTxs.length - newUniqueTxs.length;

                                        if (newUniqueTxs.length > 0) {
                                            storeData('transactions', [...existingTransactions, ...newUniqueTxs]);
                                            updateUI({ updateAccounts: true, updateTransactions: true, updateCategories: true, updateSelects: true, shouldUpdateCharts: true, shouldUpdateFilters: true, shouldUpdateTotals: true });
                                            let succMsg = `Importate con successo ${newUniqueTxs.length} nuove transazioni!`;
                                            if (skippedCount > 0) succMsg += ` (${skippedCount} transazioni duplicate sono state saltate).`;
                                            if (errors.length > 0) succMsg += ` (${errors.length} righe con errori).`;
                                            settingsElements.csvImportSuccess.textContent = succMsg;
                                        } else {
                                            let infoMsg = "Nessuna NUOVA transazione da importare.";
                                            if (skippedCount > 0) infoMsg += ` (${skippedCount} transazioni duplicate sono state saltate).`;
                                            if (errors.length > 0) infoMsg += ` (${errors.length} righe con errori).`;
                                            settingsElements.csvImportError.textContent = infoMsg;
                                            if(accountStateChanged || categoryStateChanged) { // Update UI if accounts/cats changed anyway
                                                updateUI({ updateAccounts: accountStateChanged, updateCategories: categoryStateChanged, updateSelects: true, shouldUpdateFilters: true, shouldUpdateTotals: true });
                                            }
                                        }
                                    } else {
                                        settingsElements.csvImportError.textContent = 'Importazione annullata dall\'utente.';
                                    }
                                } else {
                                    settingsElements.csvImportError.textContent = `Nessuna transazione valida trovata nel file.${rowErrMsg}`;
                                }
                            } catch (err) {
                                console.error("CSV Import Processing Error:", err);
                                settingsElements.csvImportError.textContent = `Errore durante l'analisi del CSV: ${err.message}`;
                                displayAppError(`Errore importazione CSV: ${err.message}`);
                            } finally {
                                settingsElements.importCsvInput.value = '';
                            }
                        };
                        reader.onerror = () => {
                            settingsElements.csvImportError.textContent = 'Errore durante la lettura del file CSV.';
                            settingsElements.importCsvInput.value = '';
                        };
                        reader.readAsText(file, 'UTF-8');
                    });
                }

                // Reset Data
                if (settingsElements.resetDataButton) settingsElements.resetDataButton.addEventListener('click', () => {
                    if (confirm("RESET COMPLETO DATI - SEI ASSOLUTAMENTE SICURO?\n\nQuesta azione canceller√† TUTTI i conti, transazioni, categorie, obiettivi e impostazioni memorizzati.\n\nL'AZIONE √à IRREVERSIBILE.")) {
                        if (prompt("Per confermare, scrivi ESATTAMENTE 'RESETTA TUTTO' (in maiuscolo) qui sotto:") === "RESETTA TUTTO") {
                            try {
                                localStorage.clear();
                                alert('Dati dell\'applicazione resettati! Ricarica la pagina per iniziare da capo.');
                                location.reload();
                            } catch (err) {
                                console.error("Error during data reset:", err);
                                displayAppError("Si √® verificato un errore durante il tentativo di reset dei dati.");
                            }
                        } else {
                            alert("Reset annullato. La conferma non √® stata inserita correttamente.");
                        }
                    } else {
                        alert("Reset annullato.");
                    }
                });

                elements.settingsModal.dataset.listenersAttached = 'true';
            }


            /** Parses CSV text into transaction objects. Modifies passed state arrays.
                NOTE: This version doesn't handle category hierarchy import well.
                      It primarily matches by name or creates new MAIN categories. */
            function parseCsvTransactions(csvText, currentAccState, currentCatState) {
                 const lines = csvText.trim().replace(/\r\n/g, '\n').split('\n');
                 if (lines.length < 2) throw new Error("Il file CSV √® vuoto o contiene solo l'intestazione.");

                 const parseCsvLine = (line) => {
                     const result = []; let currentField = ''; let inQuotes = false;
                     for (let i = 0; i < line.length; i++) {
                         const char = line[i]; const nextChar = line[i + 1];
                         if (!inQuotes) {
                             if (char === '"') inQuotes = true;
                             else if (char === ',') { result.push(currentField.trim()); currentField = ''; }
                             else currentField += char;
                         } else {
                             if (char === '"' && nextChar === '"') { currentField += '"'; i++; }
                             else if (char === '"') inQuotes = false;
                             else currentField += char;
                         }
                     }
                     result.push(currentField.trim()); return result;
                 };

                 const headers = parseCsvLine(lines[0]).map(h => h.toLowerCase().trim().replace(/^["']|["']$/g, ''));
                  // Look for 'categoria completa' first, fallback to 'categoria'
                 const categoryHeaderOptions = ['categoria completa', 'categoria', 'category', 'tipo', 'type'];
                 const headerMappings = {
                    date: ['data', 'date', 'data transazione', 'transaction date'],
                    amount: ['importo', 'amount', 'valore', 'value'],
                    category: categoryHeaderOptions, // Use the ordered list
                    account: ['conto', 'account', 'carta', 'card'],
                    description: ['descrizione', 'description', 'note', 'memo']
                 };
                 const findHeaderIndex = (possibleNames) => possibleNames.reduce((foundIndex, name) => foundIndex !== -1 ? foundIndex : headers.indexOf(name), -1);
                 const dateIndex = findHeaderIndex(headerMappings.date);
                 const amountIndex = findHeaderIndex(headerMappings.amount);
                 const categoryIndex = findHeaderIndex(headerMappings.category); // Finds first match in the list
                 const accountIndex = findHeaderIndex(headerMappings.account);
                 const descriptionIndex = findHeaderIndex(headerMappings.description);

                 const mandatoryHeaders = {"Data": dateIndex, "Importo": amountIndex, "Categoria": categoryIndex, "Conto": accountIndex};
                 const missingHeaders = Object.entries(mandatoryHeaders).filter(([, index]) => index === -1).map(([name]) => name);
                 if (missingHeaders.length > 0) throw new Error(`Intestazioni CSV obbligatorie mancanti: ${missingHeaders.join(', ')}.`);

                 let importedTxs = []; let errors = [];
                 let accountStateChanged = false; let categoryStateChanged = false;
                 let createdCategoryNames = new Set();
                 const fallbackAccountName = "Conto da Import CSV";
                 let fallbackAccountId = currentAccState.find(a => a.name === fallbackAccountName)?.id;

                 for (let i = 1; i < lines.length; i++) {
                     const line = lines[i].trim(); if (!line) continue;
                     try {
                         const row = parseCsvLine(line);
                         const maxIndex = Math.max(dateIndex, amountIndex, categoryIndex, accountIndex, descriptionIndex > -1 ? descriptionIndex : 0);
                         if (row.length <= maxIndex) throw new Error(`Numero di campi insufficiente.`);

                         let rawDate = row[dateIndex]; let dateString = ''; let dateParsed = false;
                         const datePatterns = [ { regex: /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/, format: m => `${m[3]}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}` }, { regex: /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/, format: m => `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}` }, { regex: /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/, format: m => `${(parseInt(m[3]) < 70 ? '20' : '19') + m[3]}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}` }, { regex: /^(\d{2})(\d{2})(\d{4})$/, format: m => `${m[3]}-${m[2]}-${m[1]}` } ];
                         for (const pattern of datePatterns) { const match = rawDate.match(pattern.regex); if (match) { dateString = pattern.format(match); dateParsed = true; break; } }
                         if (!dateParsed) { const parsedDate = new Date(rawDate); if (!isNaN(parsedDate)) { dateString = parsedDate.toISOString().slice(0, 10); dateParsed = true; } }
                         if (!dateParsed || isNaN(new Date(dateString))) throw new Error(`Formato data non riconosciuto: "${rawDate}"`);

                         let rawAmount = row[amountIndex]; let cleanedAmount = rawAmount.replace(/[^\d,\.-]/g, '');
                         const hasComma = cleanedAmount.includes(','); const hasDot = cleanedAmount.includes('.');
                         if (hasComma && hasDot) { if (cleanedAmount.lastIndexOf('.') < cleanedAmount.lastIndexOf(',')) cleanedAmount = cleanedAmount.replace(/\./g, ''); else cleanedAmount = cleanedAmount.replace(/,/g, ''); }
                         cleanedAmount = cleanedAmount.replace(',', '.'); const amount = parseFloat(cleanedAmount);
                         if (isNaN(amount)) throw new Error(`Importo non valido: "${rawAmount}"`);

                         // Attempt to find category - simplified for CSV (no hierarchy logic)
                         let categoryNameFromCsv = row[categoryIndex]?.trim();
                         if (!categoryNameFromCsv) throw new Error("Nome categoria mancante.");
                         // Try to find an exact match (main or sub) by name
                         let category = currentCatState.find(c => c.name.toLowerCase() === categoryNameFromCsv.toLowerCase());
                         let categoryIdToSave = category ? category.id : null;

                         if (!category) { // If not found by name, create a new MAIN category
                             const newCategoryId = `cat_csv_${Date.now()}_${i}`;
                             category = { id: newCategoryId, name: categoryNameFromCsv, parentId: null }; // Create as main
                             currentCatState.push(category);
                             categoryStateChanged = true;
                             createdCategoryNames.add(categoryNameFromCsv);
                             categoryIdToSave = newCategoryId;
                             console.log(`CSV Import: Created MAIN category "${categoryNameFromCsv}" (ID: ${newCategoryId}) as no match was found.`);
                         }

                         let accountName = row[accountIndex]?.trim(); if (!accountName) throw new Error("Conto mancante.");
                         let accountId = currentAccState.find(a => a.name.toLowerCase() === accountName.toLowerCase())?.id;
                         if (!accountId) { if (!fallbackAccountId) { const newFallbackId = `acc_csv_fallback_${Date.now()}`; const fallbackAccount = { id: newFallbackId, name: fallbackAccountName, initialBalance: 0, color: "#757575" }; currentAccState.push(fallbackAccount); fallbackAccountId = newFallbackId; accountStateChanged = true; console.log(`CSV Import: Created fallback account "${fallbackAccountName}"`); } accountId = fallbackAccountId; console.warn(`CSV Import (Riga ${i+1}): Conto "${accountName}" non trovato, usando fallback.`); }

                         const description = (descriptionIndex !== -1 && row[descriptionIndex]?.trim()) || '';
                         const txId = `csv_${dateString}_${amount.toFixed(2)}_${accountId.slice(-4)}_${(categoryIdToSave || 'nocat').slice(-4)}_${i}`;

                         importedTxs.push({ id: txId, date: dateString, amount, categoryId: categoryIdToSave, account: accountId, description: description || categoryNameFromCsv, transferId: null });
                     } catch (err) { errors.push({ line: i + 1, message: err.message, rawLine: line }); }
                 }
                 return { importedTxs, createdAccId: fallbackAccountId, createdCatNames: [...createdCategoryNames], errors, accountStateChanged, categoryStateChanged };
            }


            // --- Modal Management ---
            /** Sets up modal close listeners. */
            function setupModalCloseListeners() {
                document.querySelectorAll('.modal').forEach(modal => { const closeBtn = modal.querySelector('.close-button'); if (closeBtn) closeBtn.addEventListener('click', () => closeModal(modal)); modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); }); }); window.addEventListener('keydown', (e) => { if (e.key === 'Escape' || e.key === 'Esc') { const active = document.querySelector('.modal.active'); if (active) closeModal(active); } });
            }

            // --- Backup Reminder Logic ---
            function checkBackupReminder() {
                if (!elements.backupReminder) return;

                const now = Date.now();
                const daysSinceLastBackup = lastBackupTimestamp > 0 ? (now - lastBackupTimestamp) / (1000 * 60 * 60 * 24) : Infinity;

                if (daysSinceLastBackup > BACKUP_REMINDER_DAYS) {
                    console.log(`Showing backup reminder. Last backup: ${lastBackupTimestamp > 0 ? new Date(lastBackupTimestamp).toLocaleDateString() : 'Never'}`);
                    elements.backupReminder.style.display = 'block';
                } else {
                    elements.backupReminder.style.display = 'none';
                     console.log(`Backup reminder hidden. Last backup: ${new Date(lastBackupTimestamp).toLocaleDateString()}`);
                }
            }

            function hideBackupReminder() {
                 if (elements.backupReminder) {
                     elements.backupReminder.style.display = 'none';
                 }
            }

             // Setup listeners for backup reminder buttons
             if (elements.backupReminderExportBtn) {
                 elements.backupReminderExportBtn.addEventListener('click', () => {
                     // Trigger JSON export directly
                     const exportButton = document.getElementById('export-json-button');
                     if (exportButton) {
                         exportButton.click(); // This will also update the timestamp and hide the reminder
                     } else {
                         console.error("Export JSON button not found for reminder action.");
                     }
                 });
             }
             if (elements.backupReminderDismissBtn) {
                 elements.backupReminderDismissBtn.addEventListener('click', hideBackupReminder);
             }

            // --- Application Initialization ---
            /** Loads initial data after login. */
            function loadInitialData() {
                console.log("Loading initial data post-login...");
                try {
                    initializeTheme(); // Apply theme first
                    // Initial UI render
                    updateUI({
                        updateAccounts: true, updateTransactions: true, updateGoals: true,
                        updateCategories: true, // Needed for settings modal
                        updateSelects: true,    // Populate dropdowns
                        shouldUpdateCharts: true,
                        shouldUpdateFilters: true,
                        shouldUpdateTotals: true
                    });
                    setupCoreEventListeners(); // Setup Settings button, etc.
                    setupCategoryFilterListeners(); // Setup chart filter button clicks
                    checkBackupReminder(); // Check if backup reminder should be shown
                    console.log("Initial data loaded and UI rendered.");
                } catch (error) {
                    console.error("Critical error during initial data load:", error);
                    displayAppError(`Errore critico caricamento dati: ${error.message}. Prova a ricaricare.`);
                    // Revert to login screen on critical error
                    if(elements.loginSection) elements.loginSection.style.display = 'flex';
                    if(elements.appContent) elements.appContent.style.display = 'none';
                    if (elements.settingsButton) elements.settingsButton.style.display = 'none';
                    if (elements.categoryFiltersContainer) elements.categoryFiltersContainer.style.display = 'none';
                    if (elements.backupReminder) elements.backupReminder.style.display = 'none';
                }
            }

            /** Sets up core event listeners (Settings button). */
            function setupCoreEventListeners() {
                if (elements.settingsButton) {
                    if (!elements.settingsButton.dataset.listenerAttached) {
                        elements.settingsButton.addEventListener('click', () => {
                            try {
                                setupSettingsListeners(); // Ensure settings modal internal listeners are set (runs once if not attached)
                                loadCategoriesForSettings(); // Refresh category list *every time* before opening
                                clearErrorMessages(elements.settingsModal);
                                const pinIn = elements.settingsModal?.querySelector('#change-pin-input'); if (pinIn) pinIn.value = '';
                                // Clear messages specific to settings modal
                                ['#pin-change-message', '#pin-change-error', '#csv-import-error', '#csv-import-success'].forEach(s => {
                                    const el = elements.settingsModal?.querySelector(s);
                                    if (el) el.textContent = '';
                                });
                                openModal('settings-modal', false);
                            } catch(err) { console.error("Error opening settings:", err); displayAppError("Errore apertura impostazioni."); }
                        });
                        elements.settingsButton.dataset.listenerAttached = 'true';
                    }
                } else { console.warn("Settings button not found."); }
            }

             /** Sets up event listeners for category filter buttons (Multi-select for MAIN categories). */
            function setupCategoryFilterListeners() {
                if (!elements.categoryFiltersContainer || elements.categoryFiltersContainer.dataset.listenerAttached === 'true') {
                     console.log("Category filter listeners already attached or container not found.");
                     return;
                 }

                elements.categoryFiltersContainer.addEventListener('click', (event) => {
                    const button = event.target.closest('.filter-button');
                    if (!button) return;

                    const dataType = button.dataset.type; // 'income' or 'expense'
                    const mainCategoryName = button.dataset.category; // 'all' or MAIN category name
                    let filterChanged = false;

                    let targetArray;
                    if (dataType === 'income') {
                        targetArray = selectedIncomeCategories;
                    } else if (dataType === 'expense') {
                        targetArray = selectedExpenseCategories;
                    } else {
                        console.warn("Unknown filter button type:", dataType);
                        return;
                    }

                    if (mainCategoryName === 'all') {
                        // If 'all' is clicked and it's not already the active state (empty array)
                        if (targetArray.length > 0) {
                            targetArray.length = 0; // Empty the array
                            filterChanged = true;
                            console.log(`${dataType} filter reset to 'all'`);
                        }
                    } else {
                        // Specific MAIN category button clicked
                        const index = targetArray.indexOf(mainCategoryName);
                        if (index > -1) {
                            // Category is selected, remove it
                            targetArray.splice(index, 1);
                            filterChanged = true;
                            console.log(`Removed MAIN category ${mainCategoryName} from ${dataType} filter`);
                        } else {
                            // Category is not selected, add it
                            targetArray.push(mainCategoryName);
                            filterChanged = true;
                            console.log(`Added MAIN category ${mainCategoryName} to ${dataType} filter`);
                        }
                    }

                    // Update UI only if the filter selection actually changed
                    if (filterChanged) {
                        renderCategoryFilters(); // Update button styles immediately
                        updateChartTotals();     // Update total text
                        updateCharts();          // Update charts
                    }
                });

                elements.categoryFiltersContainer.dataset.listenerAttached = 'true';
                console.log("Category filter listeners attached.");
            }


            /** Final setup steps. */
            function initializeApp() {
                console.log(`Initializing Mattia Finanze v${APP_VERSION}`);
                if (elements.currentYearSpan) elements.currentYearSpan.textContent = new Date().getFullYear();
                loadAllDataFromStorage(); // Load data into state variables FIRST (includes migrations)
                initializeTheme();        // Set theme based on loaded state
                initializePinLogin();     // Setup PIN screen (hides settings btn initially)
                setupModalCloseListeners(); // Setup global modal closing
                console.log("App Initialized. Ready for PIN.");
            }

            // --- Start Application ---
            initializeApp();

        }); // End DOMContentLoaded
        // --- End PART 3 ---
    </script>
</body>
</html>
<!-- FINE PARTE 4 -->